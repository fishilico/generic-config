
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Installing a Linux system &#8212; Generic Config</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Linux NAT router" href="nat.html" />
    <link rel="prev" title="GDB, The GNU Project Debugger" href="gdb.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="nat.html" title="Linux NAT router"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="gdb.html" title="GDB, The GNU Project Debugger"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Generic Config</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Some notes and tips&amp;tricks about system administration</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="installing-a-linux-system">
<h1>Installing a Linux system<a class="headerlink" href="#installing-a-linux-system" title="Permalink to this headline">¶</a></h1>
<p>This document aims at providing the main steps in installing a Linux system.
When installing a specific Linux distribution, the documentation available on the distribution’s wiki often provides very detailed steps:</p>
<ul class="simple">
<li><p>Arch Linux’s installation guide: <a class="reference external" href="https://wiki.archlinux.org/index.php/installation_guide">https://wiki.archlinux.org/index.php/installation_guide</a></p></li>
<li><p>Gentoo’s Handbook: <a class="reference external" href="https://wiki.gentoo.org/wiki/Handbook:AMD64#Installing_Gentoo">https://wiki.gentoo.org/wiki/Handbook:AMD64#Installing_Gentoo</a></p></li>
</ul>
<div class="section" id="booting-a-live-media-to-a-live-system">
<h2>Booting a live media to a live system<a class="headerlink" href="#booting-a-live-media-to-a-live-system" title="Permalink to this headline">¶</a></h2>
<p>The first steps of installing a Linux system consist in booting on a Linux system provided as a CD-ROM image (<code class="docutils literal notranslate"><span class="pre">.iso</span></code> file) or as a live USB key image.
Such live media can also be created with tools such as:</p>
<ul class="simple">
<li><p>Fedora’s Livemedia-creator (with Anaconda): <a class="reference external" href="https://fedoraproject.org/wiki/Livemedia-creator-_How_to_create_and_use_a_Live_CD">https://fedoraproject.org/wiki/Livemedia-creator-_How_to_create_and_use_a_Live_CD</a></p></li>
<li><p>UNetbootin: <a class="reference external" href="https://unetbootin.github.io/">https://unetbootin.github.io/</a></p></li>
</ul>
<p>Once booted using the live media, the keyboard layout needs to be configured:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enumerate the available console keymaps, provided by:</span>
<span class="c1"># * package kbd on Arch Linux</span>
<span class="c1"># * package console-data on Debian</span>
ls /usr/share/kbd/keymaps/**/*.map.gz

<span class="c1"># Load a French keymap using loadkeys from:</span>
<span class="c1"># * package kbd on Arch Linux</span>
<span class="c1"># * package kbd on Debian</span>
loadkeys fr-latin9
</pre></div>
</div>
<p>For UEFI-based system, it is possible to verify that the live media has been booted in UEFI mode by enumerating the UEFI variables:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>ls /sys/firmware/efi/efivars
</pre></div>
</div>
<p>Then, it is possible to configure the network interfaces.
This greatly depends upon the network environment of the installed system.
Here are some commands to perform this:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Using DHCP</span>
dhclient eth0

<span class="c1"># Add an static IPv4 address for Ethernet interface eth0 and configure the DNS resolver</span>
ip addr add <span class="m">192</span>.168.0.2/24 dev eth0
ip route add default via <span class="m">192</span>.168.0.1
<span class="nb">echo</span> <span class="s1">&#39;nameserver 192.168.0.1&#39;</span> &gt;&gt; /etc/resolv.conf

<span class="c1"># Check the connectivity with GitHub</span>
curl -v https://github.com

<span class="c1"># Enable time synchronization, on systemd-based distribution</span>
timedatectl set-ntp <span class="nb">true</span>
</pre></div>
</div>
</div>
<div class="section" id="partitioning-the-disks">
<h2>Partitioning the disks<a class="headerlink" href="#partitioning-the-disks" title="Permalink to this headline">¶</a></h2>
<p>Once a live system is booted, the disks can be partitioned.
There does not exist a generic configuration that works for every possible computer: some could use software RAID with much swap, others do not need swap at all, etc.</p>
<p>One major differences between systems is the way a system boot:</p>
<ul class="simple">
<li><p>Legacy systems use BIOS with a MBR partition table.
<code class="docutils literal notranslate"><span class="pre">/boot</span></code> can be split in its own partition but this is not mandatory.</p></li>
<li><p>Newer systems use UEFI with a GPT partition table.
This requires a <code class="docutils literal notranslate"><span class="pre">EFI</span> <span class="pre">system</span> <span class="pre">partition</span></code> which is nowadays the <code class="docutils literal notranslate"><span class="pre">/boot</span></code> partition.
Allocating 400 MB for such a partition should be more than enough.</p></li>
</ul>
<p>When installing GRUB boot manager on a UEFI system, an other dedicated partition needs to be created.
Allocating 200 MB to it should be enough.</p>
<p>Here are useful commands for this step:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Enumerate the available disks and partitions</span>
fdisk -l
lsblk
ls -l /sys/class/block
ls -l /dev/disk/by-path

<span class="c1"># Create partitions on /dev/sda in an interactive way</span>
fdisk /dev/sda

<span class="c1"># Format the EFI system partition as FAT32</span>
mkfs.fat -F32 /dev/sda1

<span class="c1"># Format a partition as ext4</span>
mkfs.ext4 /dev/sda2

<span class="c1"># Format a partition as Swap</span>
mkswap /dev/sda2 <span class="o">&amp;&amp;</span> swapon /dev/sda2

<span class="c1"># Create an encrypted LUKS partition</span>
cryptsetup -v --cipher aes-xts-plain64 --key-size <span class="m">512</span> luksFormat /dev/sda2
cryptsetup open /dev/sda2 system
mkfs.ext4 /dev/mapper/system

<span class="c1"># Backup the LUKS header</span>
cryptsetup luksDump /dev/sda2
<span class="c1"># Optionally backup the encryption master key</span>
dmsetup ls --target crypt
dmsetup table --showkeys system

<span class="c1"># Rescan LVM partitions after a change has been made</span>
<span class="c1"># (Physical Volumes, Volume Groups and Logical Volumes)</span>
vgchange --available y  <span class="c1"># or: vgchange -ay</span>
pvscan
vgscan
vgscan --mknodes
lvscan

<span class="c1"># Mount the partitions on /mnt</span>
mount /dev/mapper/system /mnt
mount /dev/sda1 /mnt/boot
</pre></div>
</div>
<p>Some documentation:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://help.ubuntu.com/community/ResizeEncryptedPartitions">https://help.ubuntu.com/community/ResizeEncryptedPartitions</a></p></li>
</ul>
</div>
<div class="section" id="installing-a-base-system">
<h2>Installing a base system<a class="headerlink" href="#installing-a-base-system" title="Permalink to this headline">¶</a></h2>
<p>Once the disks are ready, bootstrapping a system is often achieved using one command specific to the distribution.</p>
<ul>
<li><p>Arch Linux use <code class="docutils literal notranslate"><span class="pre">pacstrap</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>pacstrap /mnt base
</pre></div>
</div>
</li>
<li><p>Debian-based system use <code class="docutils literal notranslate"><span class="pre">debootstrap</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>debootstrap --arch amd64 stable /mnt
</pre></div>
</div>
</li>
</ul>
<p>Once this is done, it is possible to <code class="docutils literal notranslate"><span class="pre">chroot</span></code> into the bootstrapped system.
Before that, the special directories need to be bind-mounted to the live system:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>mount --bind /dev /mnt/dev
mount --bind /proc /mnt/proc
mount --bind /sys /mnt/sys
chroot /mnt
</pre></div>
</div>
<p>Arch Linux provides some helper scripts to minimize the number of commands to type:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>genfstab -U /mnt &gt;&gt; /mnt/etc/fstab
arch-chroot /mnt
</pre></div>
</div>
</div>
<div class="section" id="configuring-the-base-system-before-the-first-boot">
<h2>Configuring the base system before the first boot<a class="headerlink" href="#configuring-the-base-system-before-the-first-boot" title="Permalink to this headline">¶</a></h2>
<p>Once chrooted into the newly-installed system while still being on the live system, a few things need to be configured.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set the console keyboard layout at boot (French keymap is sometimes named fr-pc)</span>
<span class="nb">echo</span> <span class="s1">&#39;KEYMAP=fr-latin9&#39;</span> &gt; /etc/vconsole.conf

<span class="c1"># Configure the timezone</span>
ln -sf <span class="s2">&quot;/usr/share/zoneinfo/</span><span class="si">${</span><span class="nv">TIMEZONE</span><span class="k">:-</span><span class="nv">UTC</span><span class="si">}</span><span class="s2">&quot;</span> /etc/localtime

<span class="c1"># Generate /etc/adjtime</span>
hwclock --systohc

<span class="c1"># Enable locales in /etc/locale.gen and generate then</span>
sed -i <span class="s1">&#39;s/^#\(en_GB.UTF-8 UTF-8\)/\1/&#39;</span> /etc/locale.gen
<span class="si">${</span><span class="nv">EDITOR</span><span class="k">:-</span><span class="nv">vim</span><span class="si">}</span> /etc/locale.gen
locale-gen
<span class="nb">echo</span> <span class="s1">&#39;LANG=en_GB.UTF-8&#39;</span> &gt; /etc/locale.conf

<span class="c1"># Configure the hostname in /etc/hostname and /etc/hosts</span>
<span class="nb">echo</span> <span class="s1">&#39;my-new-hostname&#39;</span> &gt; /etc/hostname
<span class="nb">echo</span> <span class="s1">&#39;127.0.1.1 my-new-hostname&#39;</span> &gt; /etc/hosts

<span class="c1"># Set the root password</span>
passwd

<span class="c1"># Create a new user in group adm and with /home/user as $HOME</span>
<span class="c1"># Options: -m to create home, -N no user group -G for admin groups</span>
useradd -mN -G adm,wheel user
passwd user

<span class="c1"># Install a bootloader</span>
<span class="k">if</span> <span class="nv">$USING_GRUB</span> <span class="p">;</span> <span class="k">then</span>
    grub-mkconfig -o /boot/grub/grub.cfg
    grub-install /dev/sda
<span class="k">fi</span>
<span class="k">if</span> <span class="nv">$USING_UEFI</span> <span class="p">;</span> <span class="k">then</span>
    cat &gt;&gt; /boot/loader/entries/00-arch-linux-hardened.conf
title Arch Linux Hardened kernel
linux /vmlinuz-linux-hardened
initrd /intel-ucode.img
initrd /initramfs-linux-hardened.img
options <span class="nv">root</span><span class="o">=</span><span class="nv">UUID</span><span class="o">=</span>...
EOF

    <span class="c1"># Install the systemd-boot EFI boot manager</span>
    bootctl install
<span class="k">fi</span>

<span class="c1"># Install the needed firmware, for example for the network interface controller</span>
apt-get -y install firmware-linux-free  <span class="c1"># on Debian</span>
pacman -S --noconfirm linux-firmware  <span class="c1"># on Arch Linux</span>
</pre></div>
</div>
<p>If the main system partition is encrypted, the initramfs needs to be regenerated.
The hooks need to be modified accordingly in <code class="docutils literal notranslate"><span class="pre">/etc/mkinitcpio.conf</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initial line:</span>
<span class="c1">#HOOKS=(base udev autodetect modconf block filesystems keyboard fsck)</span>
<span class="c1"># New line:</span>
<span class="nv">HOOKS</span><span class="o">=(</span>base udev autodetect modconf block keymap keyboard encrypt filesystems fsck<span class="o">)</span>
</pre></div>
</div>
<p>And run <code class="docutils literal notranslate"><span class="pre">mkinitcpio</span> <span class="pre">-p</span> <span class="pre">linux</span></code>.
The kernel boot command line also needs to be adjusted to include information about the encrypted partition:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="o">=</span><span class="n">UUID</span><span class="o">=</span><span class="n">xxxxxxxx</span><span class="o">-...-</span><span class="n">xxxxxxxxxxxx</span> <span class="n">cryptdevice</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">uuid</span><span class="o">/</span><span class="n">xxxxxxxx</span><span class="o">-...-</span><span class="n">xxxxxxxxxxxx</span><span class="p">:</span><span class="n">system</span>
</pre></div>
</div>
<p>If the system is supposed to be unlocked remotely (for example by entering the encryption passphrase in a Dropbear SSH server embedded in the initramfs), some actions need to be performed (<a class="reference external" href="https://wiki.archlinux.org/index.php/Dm-crypt/Specialties#Remote_unlocking_of_the_root_%28or_other%29_partition">https://wiki.archlinux.org/index.php/Dm-crypt/Specialties#Remote_unlocking_of_the_root_%28or_other%29_partition</a>):</p>
<ul>
<li><p>Configure a SSH public key in <code class="docutils literal notranslate"><span class="pre">/etc/dropbear/root_key</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/tinyssh/root_key</span></code></p></li>
<li><p>Add <code class="docutils literal notranslate"><span class="pre">netconf</span> <span class="pre">dropbear</span> <span class="pre">encryptssh</span></code> hooks in <code class="docutils literal notranslate"><span class="pre">/etc/mkinitcpio.conf</span></code> before <code class="docutils literal notranslate"><span class="pre">filesystem</span></code></p></li>
<li><p>Configure <code class="docutils literal notranslate"><span class="pre">cryptdevice</span></code> and <code class="docutils literal notranslate"><span class="pre">ip</span></code> parameters in the kernel boot command. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cryptdevice</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">disk</span><span class="o">/</span><span class="n">by</span><span class="o">-</span><span class="n">uuid</span><span class="o">/</span><span class="n">xxxxxxxx</span><span class="o">-...-</span><span class="n">xxxxxxxxxxxx</span><span class="p">:</span><span class="n">system</span>
<span class="n">ip</span><span class="o">=</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.2</span><span class="p">::</span><span class="mf">192.168</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mf">255.255</span><span class="o">.</span><span class="mf">255.0</span><span class="p">:</span><span class="n">myhostname</span><span class="p">:</span><span class="n">eth0</span><span class="p">:</span><span class="n">none</span>
</pre></div>
</div>
</li>
</ul>
<p>While at it, here are some other useful options:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">verbose</span> <span class="n">loglevel</span><span class="o">=</span><span class="mi">6</span> <span class="n">kaslr</span> <span class="n">intel_iommu</span><span class="o">=</span><span class="n">on</span> <span class="n">audit</span><span class="o">=</span><span class="mi">1</span> <span class="n">security</span><span class="o">=</span><span class="n">selinux</span> <span class="n">selinux</span><span class="o">=</span><span class="mi">1</span>
</pre></div>
</div>
<p>On a local system, it is a good idea to ensure that the USB-HID kernel modules (that handle the keyboard) are always loaded.
Otherwise, a USB keyboard cannot be used to enter the disk encryption passphrase upon boot…
It is also nice to ensure that the module for FAT filesystems is loaded, in order to be able to plug USB sticks even after disabling the module loading on the system.</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">echo</span> <span class="s1">&#39;MODULES=(hid-generic vfat)&#39;</span> &gt;&gt; /etc/mkinitcpio.conf
</pre></div>
</div>
<p>If the system is remotely available through SSH, enable the server:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># On Debian-based systems</span>
systemctl <span class="nb">enable</span> ssh
<span class="c1"># On Arch Linux</span>
systemctl <span class="nb">enable</span> sshd
</pre></div>
</div>
<p>If the system is a remote one and has an encrypted disk partition, remote unlocking can be achieved by embedding a Dropbear SSH server in the initramfs.
Such a configuration is detailed on <a class="reference external" href="https://wiki.archlinux.org/index.php/Dm-crypt/Specialties">https://wiki.archlinux.org/index.php/Dm-crypt/Specialties</a>.</p>
</div>
<div class="section" id="the-last-installation-step">
<h2>The last installation step<a class="headerlink" href="#the-last-installation-step" title="Permalink to this headline">¶</a></h2>
<p>Finally, exit the chroot, unmount the system disks and reboot the system.
With this, the base system is installed and it is possible to install software, use them, etc.
A list of useful packages for some distributions is available on <a class="reference external" href="https://github.com/fishilico/shared/tree/master/machines/base_install">https://github.com/fishilico/shared/tree/master/machines/base_install</a>.</p>
<p>It is also recommended to configure OpenSSH, sudo, sysctl, iptables, XScreenSaver, etc.
<a class="reference external" href="https://fishilico.github.io/generic-config/">https://fishilico.github.io/generic-config/</a> provides some help in this regard.</p>
<p>On Debian-based systems, <a class="reference external" href="debian.rst">debian.rst</a> (<a class="reference internal" href="debian.html"><span class="doc">Some information of Debian systems</span></a>) provides also some advices.</p>
<p>On Arch Linux systems, <a class="reference external" href="archlinux-pkg.rst">archlinux-pkg.rst</a> (<a class="reference internal" href="archlinux-pkg.html"><span class="doc">Notes about Arch Linux packages</span></a>) has some too.
Also, please add <code class="docutils literal notranslate"><span class="pre">ILoveCandy</span></code> in section <code class="docutils literal notranslate"><span class="pre">[options]</span></code> in <code class="docutils literal notranslate"><span class="pre">/etc/pacman.conf</span></code> ;)</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Installing a Linux system</a><ul>
<li><a class="reference internal" href="#booting-a-live-media-to-a-live-system">Booting a live media to a live system</a></li>
<li><a class="reference internal" href="#partitioning-the-disks">Partitioning the disks</a></li>
<li><a class="reference internal" href="#installing-a-base-system">Installing a base system</a></li>
<li><a class="reference internal" href="#configuring-the-base-system-before-the-first-boot">Configuring the base system before the first boot</a></li>
<li><a class="reference internal" href="#the-last-installation-step">The last installation step</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="gdb.html"
                        title="previous chapter">GDB, The GNU Project Debugger</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="nat.html"
                        title="next chapter">Linux NAT router</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/sysadmin/installation.rst.txt"
           rel="nofollow">Show Source</a></li>
    <li><a href="https://github.com/fishilico/generic-config/blob/master/sysadmin/installation.rst"
           rel="nofollow">Show Source on GitHub
           <img src="../_static/GitHub-Mark-32px.png" style="width: 1.5em; border: none;" alt="" />
           </a></li>
  </ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="nat.html" title="Linux NAT router"
             >next</a> |</li>
        <li class="right" >
          <a href="gdb.html" title="GDB, The GNU Project Debugger"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Generic Config</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Some notes and tips&amp;tricks about system administration</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2019, Nicolas Iooss.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.2.2.
    </div>
  </body>
</html>