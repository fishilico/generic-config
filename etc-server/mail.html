<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>Mail server configuration with Postfix and dovecot &mdash; Generic Config</title>
    
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '0.1',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Generic Config" href="../index.html" />
    <link rel="up" title="/etc for Server" href="index.html" />
    <link rel="next" title="etc-server/mysql/my.cnf" href="mysql/my.cnf.raw.html" />
    <link rel="prev" title="ejabberd configuration" href="jabber/ejabberd.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="mysql/my.cnf.raw.html" title="etc-server/mysql/my.cnf"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="jabber/ejabberd.html" title="ejabberd configuration"
             accesskey="P">previous</a> |</li>
        <li><a href="../index.html">Generic Config</a> &raquo;</li>
          <li><a href="index.html" accesskey="U"><tt class="docutils literal"><span class="pre">/etc</span></tt> for Server</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <div class="section" id="mail-server-configuration-with-postfix-and-dovecot">
<h1>Mail server configuration with Postfix and dovecot<a class="headerlink" href="#mail-server-configuration-with-postfix-and-dovecot" title="Permalink to this headline">¶</a></h1>
<p>This document describes 3 possible configurations:</p>
<ul class="simple">
<li>Simple server, where a local postfix server is used to send system messages
(cron, alerts...) to system admins.</li>
<li>Relay mail server, which is used to relay messages for a domain to real
mailbox (aliases).</li>
<li>Mailbox mail server, which is used to receive messages in user mailboxes which
can then be accessed through IMAP.</li>
</ul>
<p>Debian provides other configuration templates when installing <tt class="docutils literal"><span class="pre">postfix</span></tt>
package (or through <tt class="docutils literal"><span class="pre">dpkg-reconfigure</span> <span class="pre">postfix</span></tt>), like <em>Satellite system</em> and
<em>Internet with smarthost</em>.</p>
<div class="section" id="local-mail-server">
<h2>Local mail server<a class="headerlink" href="#local-mail-server" title="Permalink to this headline">¶</a></h2>
<p>Here are config files for a server named <tt class="docutils literal"><span class="pre">examplehost</span></tt> in domain <tt class="docutils literal"><span class="pre">example.com</span></tt>.</p>
<p><tt class="docutils literal"><span class="pre">/etc/postfix/main.cf</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># Some straightforward configuration</span>
<span class="nv">smtpd_banner</span> <span class="o">=</span> <span class="nv">$myhostname</span> ESMTP <span class="nv">$mail_name</span>
<span class="nv">biff</span> <span class="o">=</span> no
<span class="nv">readme_directory</span> <span class="o">=</span> no
<span class="nv">mailbox_size_limit</span> <span class="o">=</span> 0

<span class="c"># Appending .domain is the MUA&#39;s job.</span>
<span class="nv">append_dot_mydomain</span> <span class="o">=</span> no

<span class="c"># Uncomment the next line to generate &quot;delayed mail&quot; warnings</span>
<span class="c">#delay_warning_time = 4h</span>

<span class="c"># TLS parameters</span>
<span class="nv">smtpd_tls_cert_file</span><span class="o">=</span>/etc/ssl/certs/ssl-cert-snakeoil.pem
<span class="nv">smtpd_tls_key_file</span><span class="o">=</span>/etc/ssl/private/ssl-cert-snakeoil.key
<span class="nv">smtpd_use_tls</span><span class="o">=</span>yes
<span class="nv">smtpd_tls_session_cache_database</span> <span class="o">=</span> btree:<span class="k">${</span><span class="nv">data_directory</span><span class="k">}</span>/smtpd_scache
<span class="nv">smtp_tls_session_cache_database</span> <span class="o">=</span> btree:<span class="k">${</span><span class="nv">data_directory</span><span class="k">}</span>/smtp_scache
<span class="c"># Exclude some protocols to mitigate SSL attacks</span>
<span class="nv">smtpd_tls_mandatory_protocols</span><span class="o">=</span>!SSLv2,!SSLv3
<span class="nv">smtp_tls_mandatory_protocols</span><span class="o">=</span>!SSLv2,!SSLv3
<span class="nv">smtpd_tls_protocols</span><span class="o">=</span>!SSLv2,!SSLv3
<span class="nv">smtp_tls_protocols</span><span class="o">=</span>!SSLv2,!SSLv3
<span class="nv">smtpd_tls_exclude_ciphers</span> <span class="o">=</span> aNULL, eNULL, EXPORT, DES, RC4, MD5, PSK, aECDH, EDH-DSS-DES-CBC3-SHA, EDH-RSA-DES-CDC3-SHA, KRB5-DE5, CBC3-SHA
<span class="c"># The Diffie-Hellman parameters file can be generated with:</span>
<span class="c"># openssl dhparam -out /etc/postfix/ssl/dh_1024.pem 1024</span>
<span class="nv">smtpd_tls_dh1024_param_file</span> <span class="o">=</span> <span class="k">${</span><span class="nv">config_directory</span><span class="k">}</span>/ssl/dh_1024.pem

<span class="c"># Fully-qualified domain name of the machine</span>
<span class="nv">myhostname</span> <span class="o">=</span> examplehost.example.com

<span class="c"># The domain associated wth the mailing system</span>
<span class="c"># By default is it $myhostname without the first prefix</span>
<span class="c">#mydomain = example.com</span>

<span class="c"># Mail addresses without a domain will use this one</span>
<span class="nv">myorigin</span> <span class="o">=</span> <span class="nv">$myhostname</span>

<span class="c"># Networks for which the host should relay mail</span>
<span class="nv">mynetworks</span> <span class="o">=</span> 127.0.0.0/8 <span class="o">[</span>::ffff:127.0.0.0<span class="o">]</span>/104 <span class="o">[</span>::1<span class="o">]</span>/128
<span class="nv">mynetworks_style</span> <span class="o">=</span> host
<span class="nv">mailbox_size_limit</span> <span class="o">=</span> 0

<span class="c"># Domains for which a local lookup needs to be performed</span>
<span class="c"># By default, relay_domains = $mydestination so no need to write it down</span>
<span class="nv">mydestination</span> <span class="o">=</span> <span class="nv">$myhostname</span>, localhost.<span class="nv">$mydomain</span>, localhost

<span class="c"># Only support local delivery</span>
<span class="nv">default_transport</span> <span class="o">=</span> error: Local delivery only!

<span class="c"># Define alias databases</span>
<span class="nv">alias_maps</span> <span class="o">=</span> <span class="nb">hash</span>:/etc/aliases
<span class="nv">alias_database</span> <span class="o">=</span> <span class="nb">hash</span>:/etc/aliases

<span class="c"># &quot;smarthost&quot; to send messages to</span>
<span class="nv">relayhost</span> <span class="o">=</span>

<span class="c"># Character which is used to define a local address extension</span>
<span class="nv">recipient_delimiter</span> <span class="o">=</span> +

<span class="c"># Only listen to the loopback interface</span>
<span class="nv">inet_interfaces</span> <span class="o">=</span> loopback-only

<span class="c"># Use IPv4 and IPv6</span>
<span class="nv">inet_protocols</span> <span class="o">=</span> all
</pre></div>
</div>
<p>File <tt class="docutils literal"><span class="pre">/etc/postfix/master.cf</span></tt> does not need to be changed relatively to the default one:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># Postfix master process configuration file.  For details on the format</span>
<span class="c"># of the file, see the master(5) manual page (command: &quot;man 5 master&quot;).</span>
<span class="c">#</span>
<span class="c"># Do not forget to execute &quot;postfix reload&quot; after editing this file.</span>
<span class="c">#</span>
<span class="c"># ==========================================================================</span>
<span class="c"># service type  private unpriv  chroot  wakeup  maxproc command + args</span>
<span class="c">#               (yes)   (yes)   (yes)   (never) (100)</span>
<span class="c"># ==========================================================================</span>
smtp      inet  n       -       -       -       -       smtpd
pickup    fifo  n       -       -       60      1       pickup
cleanup   unix  n       -       -       -       0       cleanup
qmgr      fifo  n       -       n       300     1       qmgr
tlsmgr    unix  -       -       -       1000?   1       tlsmgr
rewrite   unix  -       -       -       -       -       trivial-rewrite
bounce    unix  -       -       -       -       0       bounce
defer     unix  -       -       -       -       0       bounce
trace     unix  -       -       -       -       0       bounce
verify    unix  -       -       -       -       1       verify
flush     unix  n       -       -       1000?   0       flush
proxymap  unix  -       -       n       -       -       proxymap
proxywrite unix -       -       n       -       1       proxymap
smtp      unix  -       -       -       -       -       smtp
relay     unix  -       -       -       -       -       smtp
showq     unix  n       -       -       -       -       showq
error     unix  -       -       -       -       -       error
retry     unix  -       -       -       -       -       error
discard   unix  -       -       -       -       -       discard
<span class="nb">local     </span>unix  -       n       n       -       -       <span class="nb">local</span>
virtual   unix  -       n       n       -       -       virtual
lmtp      unix  -       -       -       -       -       lmtp
anvil     unix  -       -       -       -       1       anvil
scache    unix  -       -       -       -       1       scache
<span class="c">#</span>
<span class="c"># ====================================================================</span>
<span class="c"># Interfaces to non-Postfix software. Be sure to examine the manual</span>
<span class="c"># pages of the non-Postfix software to find out what options it wants.</span>
<span class="c">#</span>
<span class="c"># Many of the following services use the Postfix pipe(8) delivery</span>
<span class="c"># agent.  See the pipe(8) man page for information about ${recipient}</span>
<span class="c"># and other message envelope options.</span>
<span class="c"># ====================================================================</span>
<span class="c">#</span>
<span class="c"># maildrop. See the Postfix MAILDROP_README file for details.</span>
<span class="c"># Also specify in main.cf: maildrop_destination_recipient_limit=1</span>
<span class="c">#</span>
maildrop  unix  -       n       n       -       -       pipe
  <span class="nv">flags</span><span class="o">=</span>DRhu <span class="nv">user</span><span class="o">=</span>vmail <span class="nv">argv</span><span class="o">=</span>/usr/bin/maildrop -d <span class="k">${</span><span class="nv">recipient</span><span class="k">}</span>
</pre></div>
</div>
<p>Finally <tt class="docutils literal"><span class="pre">/etc/aliases</span></tt> may contain some aliases so that most messages get
sent to user <tt class="docutils literal"><span class="pre">localuser</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># See man 5 aliases for format</span>
root: localuser
mailer-daemon: postmaster
abuse: root
hostmaster: root
postmaster: root
nobody: root
webmaster: root
www: root
</pre></div>
</div>
<p>Run <tt class="docutils literal"><span class="pre">newaliases</span></tt> every time this file is updated.</p>
<p>To validate the configuration, run <tt class="docutils literal"><span class="pre">postfix</span> <span class="pre">check</span></tt>.</p>
</div>
<div class="section" id="relay-mode-configuration">
<h2>Relay-mode configuration<a class="headerlink" href="#relay-mode-configuration" title="Permalink to this headline">¶</a></h2>
<p>This section describes a Postfix configuration for a relay domain, which
transmits e-mails to addresses behind aliases.  To set-up such a server,
it is possible to use the same configuration as the local mail server, with
a modification to <tt class="docutils literal"><span class="pre">/etc/postfix/main.cf</span></tt> to allow connections from all
network interfaces:</p>
<div class="highlight-python"><div class="highlight"><pre><span class="n">inet_interfaces</span> <span class="o">=</span> <span class="nb">all</span>
</pre></div>
</div>
<p>The aliases can then be configured in <tt class="docutils literal"><span class="pre">/etc/aliases</span></tt>, or more generally to
the file configured in <tt class="docutils literal"><span class="pre">alias_maps</span></tt> and <tt class="docutils literal"><span class="pre">alias_database</span></tt> variables</p>
<div class="highlight-console"><div class="highlight"><pre><span class="gp">$</span> postconf |grep <span class="s1">&#39;^alias_&#39;</span>
<span class="go">alias_database = hash:/etc/aliases</span>
<span class="go">alias_maps = hash:/etc/aliases</span>
</pre></div>
</div>
<p>To send local emails as <tt class="docutils literal"><span class="pre">root+hostname&#64;example.com</span></tt> instead of
<tt class="docutils literal"><span class="pre">root&#64;hostname.example.com</span></tt>, a canonical mapping can be added:</p>
<ul>
<li><p class="first">in <tt class="docutils literal"><span class="pre">`/etc/postfix/main.cf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>canonical_classes = envelope_sender, header_sender, header_recipient
canonical_maps = regexp:/etc/postfix/canonical.regexp
</pre></div>
</div>
</li>
<li><p class="first">in <tt class="docutils literal"><span class="pre">/etc/postfix/canonical.regexp</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>/^([^@]*)@([a-zA-Z0-9]*)\.(example\.com)/ ${1}+${2}@${3}
</pre></div>
</div>
</li>
<li><p class="first">and finally compile the mapping with <tt class="docutils literal"><span class="pre">postmap</span> <span class="pre">/etc/postfix/canonical.regexp</span></tt>.</p>
</li>
</ul>
<p>To enable SMTPS as STARTTLS over SMTP (TCP port 587), add the following lines to
<tt class="docutils literal"><span class="pre">/etc/postfix/master.cf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>submission inet n       -       -       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_client_restrictions=permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
</pre></div>
</div>
<p>In this configuration <tt class="docutils literal"><span class="pre">smtpd_client_restrictions</span></tt> disables
<tt class="docutils literal"><span class="pre">reject_unauth_destination</span></tt> so that relaying over SMTPS works.</p>
<p>On the firewall, TCP ports 25 and 587 need to be opened for SMTP and SMTPS, and
143 and 993 for IMAP (with STARTTLS) and IMAPS.  With iptables, the commands
are:</p>
<div class="highlight-python"><div class="highlight"><pre>iptables -A INPUT -p tcp -m multiport --dports 25,143,587,993 -j ACCEPT
iptables -A OUTPUT -p tcp -m multiport --sports 25,143,587,993 -j ACCEPT
ip6tables -A INPUT -p tcp -m multiport --dports 25,143,587,993 -j ACCEPT
ip6tables -A OUTPUT -p tcp -m multiport --sports 25,143,587,993 -j ACCEPT
</pre></div>
</div>
</div>
<div class="section" id="mailbox-mail-server">
<h2>Mailbox mail server<a class="headerlink" href="#mailbox-mail-server" title="Permalink to this headline">¶</a></h2>
<p>To setup a mail server with mailboxes, the first step is to setup the relay-mode
configuration, and then add local accounts and configure dovecot to serve the
mailbox of these accounts over IMAP.</p>
<p>To install dovecot on Debian, two packages need to be installed:</p>
<div class="highlight-python"><div class="highlight"><pre>aptitude install dovecot-core dovecot-imapd
</pre></div>
</div>
<p>Then the default configuration is available through <tt class="docutils literal"><span class="pre">doveconf</span> <span class="pre">-n</span></tt> command.
This can be use as a source of inspiration, but customizations are simpler when
everything lies in a single file.  By default, <tt class="docutils literal"><span class="pre">dovecot.conf</span></tt> includes every
file matched by glob pattern <tt class="docutils literal"><span class="pre">/etc/dovecot/conf.d/*.conf</span></tt> and tries to include
<tt class="docutils literal"><span class="pre">/etc/dovecot/local.conf</span></tt> with:</p>
<div class="highlight-python"><div class="highlight"><pre>!include_try local.conf
</pre></div>
</div>
<p>To fully control the configuration, it is possible to comment
<tt class="docutils literal"><span class="pre">!include</span> <span class="pre">conf.d/*.conf</span></tt> and write in <tt class="docutils literal"><span class="pre">/etc/dovecot/local.conf</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># Enable and require TLS communication</span>
<span class="nv">ssl</span> <span class="o">=</span> required
<span class="nv">ssl_cert</span> <span class="o">=</span> &lt;/etc/ssl/dovecot/dovecot.crt
<span class="c"># Do not forget to make /etc/ssl/dovecot/dovecot.key only readable by root</span>
<span class="nv">ssl_key</span> <span class="o">=</span> &lt;/etc/ssl/dovecot/dovecot.key

<span class="c"># Disable plaintext authentication</span>
<span class="nv">disable_plaintext_auth</span> <span class="o">=</span> yes

<span class="c"># Authenticate using PAM</span>
<span class="nv">auth_mechanisms</span> <span class="o">=</span> plain
userdb <span class="o">{</span>
  <span class="nv">driver</span> <span class="o">=</span> passwd
<span class="o">}</span>
passdb <span class="o">{</span>
  <span class="nv">driver</span> <span class="o">=</span> pam
<span class="o">}</span>

<span class="c"># Use Maildir</span>
<span class="nv">mail_location</span> <span class="o">=</span> maildir:~/Maildir
namespace inbox <span class="o">{</span>
  <span class="nv">inbox</span> <span class="o">=</span> yes
  <span class="c">#location =</span>
  <span class="c">#prefix =</span>
  <span class="nv">separator</span> <span class="o">=</span> /
<span class="o">}</span>

<span class="c"># Create a socket to use dovecot authentication in postfix</span>
service auth <span class="o">{</span>
  unix_listener /var/spool/postfix/private/auth <span class="o">{</span>
    <span class="nv">mode</span> <span class="o">=</span> 0660
    <span class="nv">user</span> <span class="o">=</span> postfix
    <span class="nv">group</span> <span class="o">=</span> postfix
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
<p>Also configure Postfix to use qmail-style delivery, with this in
<tt class="docutils literal"><span class="pre">/etc/postfix/main.cf</span></tt>:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># Delive mails in ~/Maildir/ (the trailing / is required)</span>
<span class="nv">home_mailbox</span> <span class="o">=</span> Maildir/
</pre></div>
</div>
<p>The dovecot authentication can then be activated in Postfix by updating the
entry for SMTPS service in <tt class="docutils literal"><span class="pre">/etc/postfix/master.cf</span></tt>:</p>
<div class="highlight-python"><div class="highlight"><pre>submission inet n       -       -       -       -       smtpd
  -o syslog_name=postfix/submission
  -o smtpd_tls_wrappermode=no
  -o smtpd_tls_security_level=encrypt
  -o smtpd_sasl_auth_enable=yes
  -o smtpd_recipient_restrictions=permit_mynetworks,permit_sasl_authenticated,reject
  -o milter_macro_daemon_name=ORIGINATING
  -o smtpd_sasl_type=dovecot
  -o smtpd_sasl_path=private/auth
</pre></div>
</div>
<p>Moreover in Postfix configuration, local delivery is configured with
<tt class="docutils literal"><span class="pre">local_recipient_maps</span></tt> which has a default value which is correct:</p>
<div class="highlight-sh"><div class="highlight"><pre><span class="c"># postconf local_recipient_maps</span>
<span class="nv">local_recipient_maps</span> <span class="o">=</span> proxy:unix:passwd.byname <span class="nv">$alias_maps</span>
</pre></div>
</div>
</div>
<div class="section" id="documentation">
<h2>Documentation<a class="headerlink" href="#documentation" title="Permalink to this headline">¶</a></h2>
<p>Here are some useful links to configure a mail server:</p>
<ul class="simple">
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/Postfix">https://wiki.archlinux.org/index.php/Postfix</a></li>
<li><a class="reference external" href="https://wiki.archlinux.org/index.php/Virtual_user_mail_system">https://wiki.archlinux.org/index.php/Virtual_user_mail_system</a></li>
<li><a class="reference external" href="http://wiki2.dovecot.org/QuickConfiguration">http://wiki2.dovecot.org/QuickConfiguration</a></li>
<li><a class="reference external" href="http://wiki2.dovecot.org/MailboxFormat">http://wiki2.dovecot.org/MailboxFormat</a> A list of mailbox formats</li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Mail server configuration with Postfix and dovecot</a><ul>
<li><a class="reference internal" href="#local-mail-server">Local mail server</a></li>
<li><a class="reference internal" href="#relay-mode-configuration">Relay-mode configuration</a></li>
<li><a class="reference internal" href="#mailbox-mail-server">Mailbox mail server</a></li>
<li><a class="reference internal" href="#documentation">Documentation</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="jabber/ejabberd.html"
                        title="previous chapter">ejabberd configuration</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="mysql/my.cnf.raw.html"
                        title="next chapter"><tt class="docutils literal"><span class="pre">etc-server/mysql/my.cnf</span></tt></a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/etc-server/mail.txt"
           rel="nofollow">Show Source</a></li>
  </ul>
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="mysql/my.cnf.raw.html" title="etc-server/mysql/my.cnf"
             >next</a> |</li>
        <li class="right" >
          <a href="jabber/ejabberd.html" title="ejabberd configuration"
             >previous</a> |</li>
        <li><a href="../index.html">Generic Config</a> &raquo;</li>
          <li><a href="index.html" ><tt class="docutils literal"><span class="pre">/etc</span></tt> for Server</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013-2016, Nicolas Iooss.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.2.2.
    </div>
  </body>
</html>