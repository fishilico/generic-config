
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>Windows Virtual Machine with Vagrant &#8212; Generic Config</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <script type="text/javascript" src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="WinDbg-kd, Windows Kernel Debugging" href="windbg-kd.html" />
    <link rel="prev" title="Set hardware clock to UTC" href="utc-clock.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="windbg-kd.html" title="WinDbg-kd, Windows Kernel Debugging"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="utc-clock.html" title="Set hardware clock to UTC"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Generic Config</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Windows system information</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="windows-virtual-machine-with-vagrant">
<h1>Windows Virtual Machine with Vagrant<a class="headerlink" href="#windows-virtual-machine-with-vagrant" title="Permalink to this headline">¶</a></h1>
<p>Microsoft provides free Windows Vircual Machines (which expire after 90 days) on
<a class="reference external" href="https://developer.microsoft.com/en-us/microsoft-edge/">https://developer.microsoft.com/en-us/microsoft-edge/</a>.
Among the available VM are Vagrant machines. Here are instructions to setup
a Windows VM through Vagrant using Libvirt and QEmu-KVM as backend.</p>
<div class="section" id="create-a-libvirt-box">
<h2>Create a Libvirt box<a class="headerlink" href="#create-a-libvirt-box" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Download a ZIP from <a class="reference external" href="https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/">https://developer.microsoft.com/en-us/microsoft-edge/tools/vms/</a>, like
<a class="reference external" href="https://az792536.vo.msecnd.net/vms/VMBuild_20180425/Vagrant/MSEdge/MSEdge.Win10.Vagrant.zip">https://az792536.vo.msecnd.net/vms/VMBuild_20180425/Vagrant/MSEdge/MSEdge.Win10.Vagrant.zip</a></p>
<ul class="simple">
<li><p>Or pull the Vagrant image from <a class="reference external" href="https://app.vagrantup.com/Microsoft/boxes/EdgeOnWindows10">https://app.vagrantup.com/Microsoft/boxes/EdgeOnWindows10</a></p></li>
</ul>
</li>
<li><p>Extract the box from the ZIP (it is named for example <code class="docutils literal notranslate"><span class="pre">MSEdge</span> <span class="pre">-</span> <span class="pre">Win10.box</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">unzip</span> <span class="n">MSEdge</span><span class="o">.</span><span class="n">Win10</span><span class="o">.</span><span class="n">Vagrant</span><span class="o">.</span><span class="n">zip</span>
</pre></div>
</div>
</li>
<li><p>Import the VirtualBox-Vagrant box and mutate it to use provider <code class="docutils literal notranslate"><span class="pre">libvirt</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">plugin</span> <span class="n">install</span> <span class="n">vagrant</span><span class="o">-</span><span class="n">mutate</span>
<span class="n">vagrant</span> <span class="n">box</span> <span class="n">add</span> <span class="n">windows</span><span class="o">/</span><span class="n">win10</span><span class="o">-</span><span class="n">edge</span> <span class="s1">&#39;MSEdge - Win10.box&#39;</span>
<span class="n">vagrant</span> <span class="n">mutate</span> <span class="n">windows</span><span class="o">/</span><span class="n">win10</span><span class="o">-</span><span class="n">edge</span> <span class="n">libvirt</span>
<span class="n">vagrant</span> <span class="n">box</span> <span class="n">remove</span> <span class="o">--</span><span class="n">provider</span> <span class="n">virtualbox</span> <span class="n">windows</span><span class="o">/</span><span class="n">win10</span><span class="o">-</span><span class="n">edge</span>
</pre></div>
</div>
<p>The mutate command will use <code class="docutils literal notranslate"><span class="pre">qemu-img</span> <span class="pre">convert</span> <span class="pre">-p</span> <span class="pre">-S</span> <span class="pre">16k</span> <span class="pre">-o</span> <span class="pre">compat=1.1</span> <span class="pre">-O</span> <span class="pre">qcow2</span> <span class="pre">...</span></code>
to convert the virtual box disk to a QEmu-compatible one.</p>
</li>
<li><p>Initialize a new Vagrant box in the current directory:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">init</span> <span class="n">windows</span><span class="o">/</span><span class="n">win10</span><span class="o">-</span><span class="n">edge</span>
</pre></div>
</div>
</li>
<li><p>Configure the box by adding the following lines to <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code> before the
final <code class="docutils literal notranslate"><span class="pre">end</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Configure remote access</span>
<span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;IEUser&quot;</span>
<span class="n">config</span><span class="o">.</span><span class="n">ssh</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;Passw0rd!&quot;</span>

<span class="c1"># Use 2 CPU and 4GB of RAM</span>
<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">provider</span> <span class="p">:</span><span class="n">libvirt</span> <span class="n">do</span> <span class="o">|</span><span class="n">v</span><span class="o">|</span>
  <span class="n">v</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="mi">2</span>
  <span class="n">v</span><span class="o">.</span><span class="n">memory</span> <span class="o">=</span> <span class="mi">4096</span>
<span class="n">end</span>
</pre></div>
</div>
</li>
<li><p>Start the new box:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vagrant</span> <span class="n">up</span> <span class="o">--</span><span class="n">provider</span> <span class="n">libvirt</span> <span class="o">--</span><span class="n">no</span><span class="o">-</span><span class="n">destroy</span><span class="o">-</span><span class="n">on</span><span class="o">-</span><span class="n">error</span>
</pre></div>
</div>
</li>
</ul>
<p>This command will fail and the console on the virtual machine will display:</p>
<div class="highlight-text notranslate"><div class="highlight"><pre><span></span>Booting from Hard disk...
No bootable device.
</pre></div>
</div>
<p>This is because the virtual machine needs to boot in UEFI mode and the network
drivers are missing. For the network issue, the next section provides a way to
fix the issue. For UEFI boot, Libvirt needs to be configured to support this
boot mode. For Arch Linux, this is documented in
<a class="reference external" href="https://wiki.archlinux.org/index.php/libvirt#UEFI_Support">https://wiki.archlinux.org/index.php/libvirt#UEFI_Support</a>. Here are some
instructions:</p>
<ul>
<li><p>Install package <code class="docutils literal notranslate"><span class="pre">ovmf</span></code>.</p></li>
<li><p>Add the following statements to <code class="docutils literal notranslate"><span class="pre">/etc/libvirt/qemu.conf</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">nvram</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;/usr/share/ovmf/x64/OVMF_CODE.fd:/usr/share/ovmf/x64/OVMF_VARS.fd&quot;</span>
<span class="p">]</span>
</pre></div>
</div>
</li>
<li><p>Restart <code class="docutils literal notranslate"><span class="pre">libvirtd</span></code> (for example with <code class="docutils literal notranslate"><span class="pre">systemctl</span> <span class="pre">restart</span> <span class="pre">libvirtd</span></code>).</p></li>
<li><p>Run <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">edit</span> <span class="pre">windows_default</span></code> (replacing <code class="docutils literal notranslate"><span class="pre">windows_default</span></code> with the
name of the domain) and insert a <code class="docutils literal notranslate"><span class="pre">&lt;loader&gt;</span></code> tag into the <code class="docutils literal notranslate"><span class="pre">&lt;os&gt;</span></code> one.
It should looks like:</p>
<div class="highlight-xml notranslate"><div class="highlight"><pre><span></span><span class="nt">&lt;os&gt;</span>
  <span class="nt">&lt;type</span> <span class="na">arch=</span><span class="s">&#39;x86_64&#39;</span> <span class="na">machine=</span><span class="s">&#39;pc-i440fx-3.0&#39;</span><span class="nt">&gt;</span>hvm<span class="nt">&lt;/type&gt;</span>
  <span class="nt">&lt;loader</span> <span class="na">readonly=</span><span class="s">&#39;yes&#39;</span> <span class="na">secure=</span><span class="s">&#39;no&#39;</span> <span class="na">type=</span><span class="s">&#39;rom&#39;</span><span class="nt">&gt;</span>/usr/share/ovmf/x64/OVMF_CODE.fd<span class="nt">&lt;/loader&gt;</span>
  <span class="nt">&lt;boot</span> <span class="na">dev=</span><span class="s">&#39;hd&#39;</span><span class="nt">/&gt;</span>
<span class="nt">&lt;/os&gt;</span>
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="first-configuration">
<h2>First configuration<a class="headerlink" href="#first-configuration" title="Permalink to this headline">¶</a></h2>
<p>By default the virtual machine won’t be able to use the virtual network card as
it lacks the VirtIO network drivers. The suitable drivers are provided by Redhat
in a <code class="docutils literal notranslate"><span class="pre">virtio-win</span></code> package:
<a class="reference external" href="https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/">https://docs.fedoraproject.org/en-US/quick-docs/creating-windows-virtual-machines-using-virtio-drivers/</a></p>
<ul>
<li><p>Download the floppy disk of the drivers, <a class="reference external" href="https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-virtio/virtio-win_amd64.vfd">https://fedorapeople.org/groups/virt/virtio-win/direct-downloads/latest-virtio/virtio-win_amd64.vfd</a></p></li>
<li><p>Power the virtual machine off and add the floppy drive to the VM   with
<code class="docutils literal notranslate"><span class="pre">virt-manager</span></code> (GUI) or <code class="docutils literal notranslate"><span class="pre">virsh</span> <span class="pre">edit</span> <span class="pre">windows_default</span></code> (CLI):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">disk</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;file&#39;</span> <span class="n">device</span><span class="o">=</span><span class="s1">&#39;floppy&#39;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">driver</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;raw&#39;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">source</span> <span class="n">file</span><span class="o">=</span><span class="s1">&#39;/path/to/virtio-win_amd64.vfd&#39;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">target</span> <span class="n">dev</span><span class="o">=</span><span class="s1">&#39;fda&#39;</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">readonly</span><span class="o">/&gt;</span>
  <span class="o">&lt;</span><span class="n">address</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;drive&#39;</span> <span class="n">controller</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="n">bus</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="n">target</span><span class="o">=</span><span class="s1">&#39;0&#39;</span> <span class="n">unit</span><span class="o">=</span><span class="s1">&#39;0&#39;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">disk</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p>Then power the machine on (through Libvirt), open the Explorer (<code class="docutils literal notranslate"><span class="pre">Win</span></code> +
<code class="docutils literal notranslate"><span class="pre">E</span></code>), go to directory <code class="docutils literal notranslate"><span class="pre">A:\amd64\Win10\</span></code> and install all <code class="docutils literal notranslate"><span class="pre">.inf</span></code> files.
There are 3 drivers:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">netkvm.inf</span></code> for the Virtio Ethernet Adapter,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">vioscsi.inf</span></code> for the VirtIO SCSI pass-through controller,</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">viostor.inf</span></code> for the VirtIO SCSI controller.</p></li>
</ul>
</li>
</ul>
<p>These commands install a French keyboard layout:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PowerShell</span> <span class="n">Set</span><span class="o">-</span><span class="n">WinUserLanguageList</span> <span class="n">fr</span><span class="o">-</span><span class="n">FR</span><span class="p">,</span><span class="n">en</span><span class="o">-</span><span class="n">US</span>
<span class="n">PowerShell</span> <span class="n">Get</span><span class="o">-</span><span class="n">WinUserLanguageList</span>
</pre></div>
</div>
</div>
<div class="section" id="remote-access">
<h2>Remote access<a class="headerlink" href="#remote-access" title="Permalink to this headline">¶</a></h2>
<div class="section" id="rdp-connection">
<h3>RDP connection<a class="headerlink" href="#rdp-connection" title="Permalink to this headline">¶</a></h3>
<p>In order to use the graphical interface, Vagrant supports using RDP (Remote
Desktop Protocol), using <code class="docutils literal notranslate"><span class="pre">freerdp</span></code> (<code class="docutils literal notranslate"><span class="pre">rdesktop</span></code> can also be used if CredSSP
is disabled on the Windows virtual machine).
Before being able to connect, the RDP server needs to be started and the
firewall opened:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Set</span><span class="o">-</span><span class="n">ItemProperty</span> <span class="o">-</span><span class="n">Path</span> <span class="s2">&quot;HKLM:\System\CurrentControlSet\Control\Terminal Server&quot;</span> <span class="o">-</span><span class="n">Name</span> <span class="s2">&quot;fDenyTSConnections&quot;</span> <span class="o">-</span><span class="n">Value</span> <span class="mi">0</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Enable</span><span class="o">-</span><span class="n">NetFirewallRule</span> <span class="o">-</span><span class="n">DisplayGroup</span> <span class="s2">&quot;Remote Desktop&quot;</span>
</pre></div>
</div>
<p>Then, one of these command should work (from a shell on the host):</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>vagrant rdp
xfreerdp /u:IEUser <span class="s1">&#39;/p:Passw0rd!&#39;</span> <span class="s2">&quot;/v:</span><span class="k">$(</span>vagrant ssh-config <span class="p">|</span> sed -n <span class="s1">&#39;s/ *HostName *//p&#39;</span><span class="k">)</span><span class="s2">:3389&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="using-winrm">
<h3>Using WinRM<a class="headerlink" href="#using-winrm" title="Permalink to this headline">¶</a></h3>
<p>In order to use WinRM to connect to the machine, add the following information
to the <code class="docutils literal notranslate"><span class="pre">Vagrantfile</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Use Windows Remote Management protocol (WinRM)</span>
<span class="n">config</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">communicator</span> <span class="o">=</span> <span class="s2">&quot;winrm&quot;</span>
<span class="n">config</span><span class="o">.</span><span class="n">winrm</span><span class="o">.</span><span class="n">username</span> <span class="o">=</span> <span class="s2">&quot;IEUser&quot;</span>
<span class="n">config</span><span class="o">.</span><span class="n">winrm</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s2">&quot;Passw0rd!&quot;</span>
</pre></div>
</div>
<p>In a command-line prompt (eg. in <code class="docutils literal notranslate"><span class="pre">vagrant</span> <span class="pre">ssh</span></code>), run:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">powershell</span> <span class="o">-</span><span class="n">Command</span> <span class="n">Enable</span><span class="o">-</span><span class="n">PSRemoting</span>
</pre></div>
</div>
<p>If this commands fails with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WinRM</span> <span class="ow">is</span> <span class="n">already</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">to</span> <span class="n">receive</span> <span class="n">requests</span> <span class="n">on</span> <span class="n">this</span> <span class="n">computer</span><span class="o">.</span>
<span class="n">Set</span><span class="o">-</span><span class="n">WSManQuickConfig</span> <span class="p">:</span> <span class="o">&lt;</span><span class="n">f</span><span class="p">:</span><span class="n">WSManFault</span> <span class="n">xmlns</span><span class="p">:</span><span class="n">f</span><span class="o">=</span><span class="s2">&quot;http://schemas.microsoft.com/wbem/wsman/1/wsmanfault&quot;</span>
<span class="n">Code</span><span class="o">=</span><span class="s2">&quot;2150859113&quot;</span> <span class="n">Machine</span><span class="o">=</span><span class="s2">&quot;localhost&quot;</span><span class="o">&gt;&lt;</span><span class="n">f</span><span class="p">:</span><span class="n">Message</span><span class="o">&gt;&lt;</span><span class="n">f</span><span class="p">:</span><span class="n">ProviderFault</span> <span class="n">provider</span><span class="o">=</span><span class="s2">&quot;Config provider&quot;</span>
<span class="n">path</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">ystemroot%\system32\WsmSvc.dll&quot;</span><span class="o">&gt;&lt;</span><span class="n">f</span><span class="p">:</span><span class="n">WSManFault</span>
<span class="n">xmlns</span><span class="p">:</span><span class="n">f</span><span class="o">=</span><span class="s2">&quot;http://schemas.microsoft.com/wbem/wsman/1/wsmanfault&quot;</span> <span class="n">Code</span><span class="o">=</span><span class="s2">&quot;2150859113&quot;</span>
<span class="n">Machine</span><span class="o">=</span><span class="s2">&quot;MSEDGEWIN10&quot;</span><span class="o">&gt;&lt;</span><span class="n">f</span><span class="p">:</span><span class="n">Message</span><span class="o">&gt;</span><span class="n">WinRM</span> <span class="n">firewall</span> <span class="n">exception</span> <span class="n">will</span> <span class="ow">not</span> <span class="n">work</span> <span class="n">since</span> <span class="n">one</span> <span class="n">of</span> <span class="n">the</span> <span class="n">network</span>
<span class="n">connection</span> <span class="n">types</span> <span class="n">on</span> <span class="n">this</span> <span class="n">machine</span> <span class="ow">is</span> <span class="nb">set</span> <span class="n">to</span> <span class="n">Public</span><span class="o">.</span> <span class="n">Change</span> <span class="n">the</span> <span class="n">network</span> <span class="n">connection</span> <span class="nb">type</span> <span class="n">to</span> <span class="n">either</span>
<span class="n">Domain</span> <span class="ow">or</span> <span class="n">Private</span> <span class="ow">and</span> <span class="k">try</span> <span class="n">again</span><span class="o">.</span> <span class="o">&lt;/</span><span class="n">f</span><span class="p">:</span><span class="n">Message</span><span class="o">&gt;&lt;/</span><span class="n">f</span><span class="p">:</span><span class="n">WSManFault</span><span class="o">&gt;&lt;/</span><span class="n">f</span><span class="p">:</span><span class="n">ProviderFault</span><span class="o">&gt;&lt;/</span><span class="n">f</span><span class="p">:</span><span class="n">Message</span><span class="o">&gt;</span>
<span class="o">&lt;/</span><span class="n">f</span><span class="p">:</span><span class="n">WSManFault</span><span class="o">&gt;</span>
<span class="n">At</span> <span class="n">line</span><span class="p">:</span><span class="mi">116</span> <span class="n">char</span><span class="p">:</span><span class="mi">17</span>
<span class="o">+</span>                 <span class="n">Set</span><span class="o">-</span><span class="n">WSManQuickConfig</span> <span class="o">-</span><span class="n">force</span>
<span class="o">+</span>                 <span class="o">~~~~~~~~~~~~~~~~~~~~~~~~~~~</span>
    <span class="o">+</span> <span class="n">CategoryInfo</span>          <span class="p">:</span> <span class="n">InvalidOperation</span><span class="p">:</span> <span class="p">(:)</span> <span class="p">[</span><span class="n">Set</span><span class="o">-</span><span class="n">WSManQuickConfig</span><span class="p">],</span> <span class="n">InvalidOperationException</span>
    <span class="o">+</span> <span class="n">FullyQualifiedErrorId</span> <span class="p">:</span> <span class="n">WsManError</span><span class="p">,</span><span class="n">Microsoft</span><span class="o">.</span><span class="n">WSMan</span><span class="o">.</span><span class="n">Management</span><span class="o">.</span><span class="n">SetWSManQuickConfigCommand</span>
</pre></div>
</div>
<p>You need to change the network to a Private network. Here are some PowerShell
commands to perform this (cf. <a class="reference external" href="http://www.hurryupandwait.io/blog/fixing-winrm-firewall-exception-rule-not-working-when-internet-connection-type-is-set-to-public">http://www.hurryupandwait.io/blog/fixing-winrm-firewall-exception-rule-not-working-when-internet-connection-type-is-set-to-public</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$networkListManager = [Activator]::CreateInstance([Type]::GetTypeFromCLSID([Guid]&quot;{DCB00C01-570F-4A9B-8D69-199FDBA5723B}&quot;))
$connections = $networkListManager.GetNetworkConnections()

# Set network location to Private for all networks
$connections | % {$_.GetNetwork().SetCategory(1)}
</pre></div>
</div>
<p>Otherwise the output is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">WinRM</span> <span class="ow">is</span> <span class="n">already</span> <span class="nb">set</span> <span class="n">up</span> <span class="n">to</span> <span class="n">receive</span> <span class="n">requests</span> <span class="n">on</span> <span class="n">this</span> <span class="n">computer</span><span class="o">.</span>
<span class="n">WinRM</span> <span class="n">has</span> <span class="n">been</span> <span class="n">updated</span> <span class="k">for</span> <span class="n">remote</span> <span class="n">management</span><span class="o">.</span>
<span class="n">WinRM</span> <span class="n">firewall</span> <span class="n">exception</span> <span class="n">enabled</span><span class="o">.</span>
<span class="n">Configured</span> <span class="n">LocalAccountTokenFilterPolicy</span> <span class="n">to</span> <span class="n">grant</span> <span class="n">administrative</span> <span class="n">rights</span> <span class="n">remotely</span> <span class="n">to</span> <span class="n">local</span> <span class="n">users</span><span class="o">.</span>
</pre></div>
</div>
<p>Then:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ vagrant plugin install vagrant-winrm
$ vagrant winrm -s cmd -c ipconfig

Windows IP Configuration


Ethernet adapter Ethernet 2:

   Connection-specific DNS Suffix  . :
   Link-local IPv6 Address . . . . . : fe80::40eb:b9c3:babb:31b5%4
   IPv4 Address. . . . . . . . . . . : 192.168.121.241
   Subnet Mask . . . . . . . . . . . : 255.255.255.0
   Default Gateway . . . . . . . . . : 192.168.121.1

Tunnel adapter isatap.{8C624652-4727-4A10-9CC3-DC0C7E0177FB}:

   Media State . . . . . . . . . . . : Media disconnected
   Connection-specific DNS Suffix  . :

Tunnel adapter Teredo Tunneling Pseudo-Interface:

   Connection-specific DNS Suffix  . :
   IPv6 Address. . . . . . . . . . . : 2001:0:9d38:6ab8:248d:f1e:b27a:31df
   Link-local IPv6 Address . . . . . : fe80::248d:f1e:b27a:31df%3
   Default Gateway . . . . . . . . . : ::
</pre></div>
</div>
<p>The Windows version can be gathered using this PowerShell command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">systeminfo</span> <span class="o">|</span> <span class="n">Select</span><span class="o">-</span><span class="n">String</span> <span class="s2">&quot;^OS Name&quot;</span><span class="p">,</span><span class="s2">&quot;^OS Version&quot;</span>

<span class="n">OS</span> <span class="n">Name</span><span class="p">:</span>                   <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="mi">10</span> <span class="n">Enterprise</span> <span class="n">Evaluation</span>
<span class="n">OS</span> <span class="n">Version</span><span class="p">:</span>                <span class="mf">10.0</span><span class="o">.</span><span class="mi">17134</span> <span class="n">N</span><span class="o">/</span><span class="n">A</span> <span class="n">Build</span> <span class="mi">17134</span>
</pre></div>
</div>
<p>Or with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="p">[</span><span class="n">System</span><span class="o">.</span><span class="n">Environment</span><span class="p">]::</span><span class="n">OSVersion</span>

<span class="n">Platform</span> <span class="n">ServicePack</span> <span class="n">Version</span>      <span class="n">VersionString</span>
<span class="o">--------</span> <span class="o">-----------</span> <span class="o">-------</span>      <span class="o">-------------</span>
 <span class="n">Win32NT</span>             <span class="mf">10.0</span><span class="o">.</span><span class="mf">17134.0</span> <span class="n">Microsoft</span> <span class="n">Windows</span> <span class="n">NT</span> <span class="mf">10.0</span><span class="o">.</span><span class="mf">17134.0</span>
</pre></div>
</div>
</div>
<div class="section" id="install-windows-openssh-server">
<h3>Install Windows OpenSSH server<a class="headerlink" href="#install-windows-openssh-server" title="Permalink to this headline">¶</a></h3>
<p>Since Windows 10 Fall Creators Update (1709 or 10.0.16299), Microsoft provides
OpenSSH client (installed by default) and server (installed on demand):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PS C:\&gt; Get-WindowsCapability -Online | ? Name -like &#39;OpenSSH*&#39;
Name  : OpenSSH.Client~~~~0.0.1.0
State : Installed

Name  : OpenSSH.Server~~~~0.0.1.0
State : NotPresent
</pre></div>
</div>
<p>These capabilities are available in the graphical interface in
“Settings/Apps/Apps &amp; features/Manage optional features”.
In order to install OpenSSH server, the following command can also be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Add</span><span class="o">-</span><span class="n">WindowsCapability</span> <span class="o">-</span><span class="n">Online</span> <span class="o">-</span><span class="n">Name</span> <span class="s2">&quot;OpenSSH.Server~~~~0.0.1.0&quot;</span>
</pre></div>
</div>
<p>If the install fails with error code <code class="docutils literal notranslate"><span class="pre">0x80070002</span></code>, the issue was likely caused
by Windows Update service (e.g. it is not running, there are pending updates,
etc.). If this happens, check the state of Windows Update, reboot and try again.</p>
<p>OpenSSH server files are installed in <code class="docutils literal notranslate"><span class="pre">C:\Windows\System32\OpenSSH</span></code> (the
server is <code class="docutils literal notranslate"><span class="pre">sshd.exe</span></code> and the default configuration <code class="docutils literal notranslate"><span class="pre">sshd_config_default</span></code>).</p>
<p>In order to use it, the firewall needs to be configured, if it is not already:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">NetFirewallRule</span> <span class="o">-</span><span class="n">DisplayName</span> <span class="n">ssh</span>
<span class="n">Name</span>                  <span class="p">:</span> <span class="p">{</span><span class="mi">4</span><span class="n">C9D3CE5</span><span class="o">-</span><span class="n">D9ED</span><span class="o">-</span><span class="mi">42</span><span class="n">F1</span><span class="o">-</span><span class="mi">95</span><span class="n">A3</span><span class="o">-</span><span class="mi">1</span><span class="n">FEB069DBF34</span><span class="p">}</span>
<span class="n">DisplayName</span>           <span class="p">:</span> <span class="n">ssh</span>
<span class="n">Description</span>           <span class="p">:</span>
<span class="n">DisplayGroup</span>          <span class="p">:</span>
<span class="n">Group</span>                 <span class="p">:</span>
<span class="n">Enabled</span>               <span class="p">:</span> <span class="kc">True</span>
<span class="n">Profile</span>               <span class="p">:</span> <span class="n">Any</span>
<span class="n">Platform</span>              <span class="p">:</span> <span class="p">{}</span>
<span class="n">Direction</span>             <span class="p">:</span> <span class="n">Inbound</span>
<span class="n">Action</span>                <span class="p">:</span> <span class="n">Allow</span>
<span class="n">EdgeTraversalPolicy</span>   <span class="p">:</span> <span class="n">Block</span>
<span class="n">LooseSourceMapping</span>    <span class="p">:</span> <span class="kc">False</span>
<span class="n">LocalOnlyMapping</span>      <span class="p">:</span> <span class="kc">False</span>
<span class="n">Owner</span>                 <span class="p">:</span>
<span class="n">PrimaryStatus</span>         <span class="p">:</span> <span class="n">OK</span>
<span class="n">Status</span>                <span class="p">:</span> <span class="n">The</span> <span class="n">rule</span> <span class="n">was</span> <span class="n">parsed</span> <span class="n">successfully</span> <span class="kn">from</span> <span class="nn">the</span> <span class="n">store</span><span class="o">.</span> <span class="p">(</span><span class="mi">65536</span><span class="p">)</span>
<span class="n">EnforcementStatus</span>     <span class="p">:</span> <span class="n">NotApplicable</span>
<span class="n">PolicyStoreSource</span>     <span class="p">:</span> <span class="n">PersistentStore</span>
<span class="n">PolicyStoreSourceType</span> <span class="p">:</span> <span class="n">Local</span>

<span class="c1"># If the above rule is not returned:</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">New</span><span class="o">-</span><span class="n">NetFirewallRule</span> <span class="o">-</span><span class="n">Protocol</span> <span class="n">TCP</span> <span class="o">-</span><span class="n">LocalPort</span> <span class="mi">22</span> <span class="o">-</span><span class="n">Direction</span> <span class="n">Inbound</span> <span class="o">-</span><span class="n">Action</span> <span class="n">Allow</span> <span class="o">-</span><span class="n">DisplayName</span> <span class="n">ssh</span>
</pre></div>
</div>
<p>There are some services related to SSH (add <code class="docutils literal notranslate"><span class="pre">|</span> <span class="pre">Format-list</span> <span class="pre">*</span></code> to list more properties):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>PS C:\&gt; Get-Service | ? Name -like &#39;*ssh*&#39;
Status   Name               DisplayName
------   ----               -----------
Running  OpenSSHd           OpenSSH Server
Stopped  ssh-agent          OpenSSH Authentication Agent
Stopped  sshd               OpenSSH SSH Server
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">OpenSSHd</span></code> is the server provided by Cygwin, installed on Vagrant images by
Microsoft in <code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files\OpenSSH\usr\sbin\sshd.exe</span></code> (it comes from
<a class="reference external" href="https://www.mls-software.com/opensshd.html">https://www.mls-software.com/opensshd.html</a>).
In order to switch to the native OpenSSH server (<code class="docutils literal notranslate"><span class="pre">sshd</span></code>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Stop</span><span class="o">-</span><span class="n">Service</span> <span class="o">-</span><span class="n">Name</span> <span class="n">OpenSSHd</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Start</span><span class="o">-</span><span class="n">Service</span> <span class="o">-</span><span class="n">Name</span> <span class="n">sshd</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Set</span><span class="o">-</span><span class="n">Service</span> <span class="o">-</span><span class="n">Name</span> <span class="n">OpenSSHd</span> <span class="o">-</span><span class="n">StartupType</span> <span class="n">Disabled</span>  <span class="c1"># (or Manual)</span>
<span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Set</span><span class="o">-</span><span class="n">Service</span> <span class="o">-</span><span class="n">Name</span> <span class="n">sshd</span> <span class="o">-</span><span class="n">StartupType</span> <span class="n">Automatic</span>

<span class="c1"># Verify with: Get-Service | ? Name -like &#39;*ssh*&#39; | Format-List Status,StartType,Name,DisplayName</span>
</pre></div>
</div>
<p>After the switch, the SSH prompt given by Vagrant becomes a real <code class="docutils literal notranslate"><span class="pre">cmd.exe</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ vagrant ssh
IEUser@192.168.121.61&#39;s password:
Microsoft Windows [Version 10.0.17134.345]
(c) 2018 Microsoft Corporation. All rights reserved.

ieuser@MSEDGEWIN10 C:\Users\IEUser&gt;
</pre></div>
</div>
<p>In order to change the number of columns (ie. the line width):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">mode</span> <span class="n">con</span> <span class="n">cols</span><span class="o">=</span><span class="mi">80</span>
<span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">mode</span>
<span class="n">Status</span> <span class="k">for</span> <span class="n">device</span> <span class="n">COM1</span><span class="p">:</span>
<span class="o">-----------------------</span>
    <span class="n">Baud</span><span class="p">:</span>            <span class="mi">1200</span>
    <span class="n">Parity</span><span class="p">:</span>          <span class="kc">None</span>
    <span class="n">Data</span> <span class="n">Bits</span><span class="p">:</span>       <span class="mi">7</span>
    <span class="n">Stop</span> <span class="n">Bits</span><span class="p">:</span>       <span class="mi">1</span>
    <span class="n">Timeout</span><span class="p">:</span>         <span class="n">OFF</span>
    <span class="n">XON</span><span class="o">/</span><span class="n">XOFF</span><span class="p">:</span>        <span class="n">OFF</span>
    <span class="n">CTS</span> <span class="n">handshaking</span><span class="p">:</span> <span class="n">OFF</span>
    <span class="n">DSR</span> <span class="n">handshaking</span><span class="p">:</span> <span class="n">OFF</span>
    <span class="n">DSR</span> <span class="n">sensitivity</span><span class="p">:</span> <span class="n">OFF</span>
    <span class="n">DTR</span> <span class="n">circuit</span><span class="p">:</span>     <span class="n">ON</span>
    <span class="n">RTS</span> <span class="n">circuit</span><span class="p">:</span>     <span class="n">ON</span>


<span class="n">Status</span> <span class="k">for</span> <span class="n">device</span> <span class="n">CON</span><span class="p">:</span>
<span class="o">----------------------</span>
    <span class="n">Lines</span><span class="p">:</span>          <span class="mi">9999</span>
    <span class="n">Columns</span><span class="p">:</span>        <span class="mi">80</span>
    <span class="n">Keyboard</span> <span class="n">rate</span><span class="p">:</span>  <span class="mi">31</span>
    <span class="n">Keyboard</span> <span class="n">delay</span><span class="p">:</span> <span class="mi">1</span>
    <span class="n">Code</span> <span class="n">page</span><span class="p">:</span>      <span class="mi">437</span>
</pre></div>
</div>
<p>In order to authenticate with an RSA key generated by vagrant, the public key
needs to be written to <code class="docutils literal notranslate"><span class="pre">C:\Users\IEUser\.ssh\authorized_keys</span></code>.
This public key can be provisioned with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ ssh-keygen -y -f .vagrant/machines/default/libvirt/private_key | \
    ssh IEUser@$VMIP PowerShell &quot;Read-Host &gt; .ssh/authorized_keys&quot;
</pre></div>
</div>
</div>
</div>
<div class="section" id="enable-the-windows-subsystem-for-linux">
<h2>Enable the Windows Subsystem for Linux<a class="headerlink" href="#enable-the-windows-subsystem-for-linux" title="Permalink to this headline">¶</a></h2>
<p>To install WSL (Windows Subsystem for Linux), run this command as Administrator:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">PowerShell</span> <span class="n">Enable</span><span class="o">-</span><span class="n">WindowsOptionalFeature</span> <span class="o">-</span><span class="n">Online</span> <span class="o">-</span><span class="n">FeatureName</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="n">Subsystem</span><span class="o">-</span><span class="n">Linux</span>

<span class="n">Path</span>          <span class="p">:</span>
<span class="n">Online</span>        <span class="p">:</span> <span class="kc">True</span>
<span class="n">RestartNeeded</span> <span class="p">:</span> <span class="kc">True</span>
</pre></div>
</div>
<p>After this command, the system automatically reboots.</p>
<p>In order to check whether WSL is installed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">PowerShell</span> <span class="n">Get</span><span class="o">-</span><span class="n">WindowsOptionalFeature</span> <span class="o">-</span><span class="n">Online</span> <span class="o">-</span><span class="n">FeatureName</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="n">Subsystem</span><span class="o">-</span><span class="n">Linux</span>

<span class="n">FeatureName</span>      <span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="n">Subsystem</span><span class="o">-</span><span class="n">Linux</span>
<span class="n">DisplayName</span>      <span class="p">:</span> <span class="n">Windows</span> <span class="n">Subsystem</span> <span class="k">for</span> <span class="n">Linux</span>
<span class="n">Description</span>      <span class="p">:</span> <span class="n">Provides</span> <span class="n">services</span> <span class="ow">and</span> <span class="n">environments</span> <span class="k">for</span> <span class="n">running</span> <span class="n">native</span> <span class="n">user</span><span class="o">-</span><span class="n">mode</span> <span class="n">Linux</span> <span class="n">shells</span> <span class="ow">and</span> <span class="n">tools</span> <span class="n">on</span> <span class="n">Windows</span><span class="o">.</span>
<span class="n">RestartRequired</span>  <span class="p">:</span> <span class="n">Possible</span>
<span class="n">State</span>            <span class="p">:</span> <span class="n">Enabled</span>
<span class="n">CustomProperties</span> <span class="p">:</span>
                   <span class="n">ServerComponent</span>\<span class="n">Description</span> <span class="p">:</span> <span class="n">Provides</span> <span class="n">services</span> <span class="ow">and</span> <span class="n">environments</span> <span class="k">for</span> <span class="n">running</span> <span class="n">native</span> <span class="n">user</span><span class="o">-</span><span class="n">mode</span> <span class="n">Linux</span>
                   <span class="n">shells</span> <span class="ow">and</span> <span class="n">tools</span> <span class="n">on</span> <span class="n">Windows</span><span class="o">.</span>
                   <span class="n">ServerComponent</span>\<span class="n">DisplayName</span> <span class="p">:</span> <span class="n">Windows</span> <span class="n">Subsystem</span> <span class="k">for</span> <span class="n">Linux</span>
                   <span class="n">ServerComponent</span>\<span class="n">Id</span> <span class="p">:</span> <span class="mi">1033</span>
                   <span class="n">ServerComponent</span>\<span class="n">Type</span> <span class="p">:</span> <span class="n">Feature</span>
                   <span class="n">ServerComponent</span>\<span class="n">UniqueName</span> <span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="n">Subsystem</span><span class="o">-</span><span class="n">Linux</span>
                   <span class="n">ServerComponent</span>\<span class="n">Deploys</span>\<span class="n">Update</span>\<span class="n">Name</span> <span class="p">:</span> <span class="n">Microsoft</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="n">Subsystem</span><span class="o">-</span><span class="n">Linux</span>
</pre></div>
</div>
<p>In order to install Ubuntu, the following PowerShell commands can be used:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">curl</span> <span class="o">-</span><span class="n">L</span> <span class="o">-</span><span class="n">o</span> <span class="n">ubuntu</span><span class="o">-</span><span class="mf">1804.</span><span class="n">appx</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">aka</span><span class="o">.</span><span class="n">ms</span><span class="o">/</span><span class="n">wsl</span><span class="o">-</span><span class="n">ubuntu</span><span class="o">-</span><span class="mi">1804</span>
<span class="c1"># Or: Invoke-WebRequest -Uri https://aka.ms/wsl-ubuntu-1804 -OutFile Ubuntu-1804.appx -UseBasicParsing</span>
<span class="n">Rename</span><span class="o">-</span><span class="n">Item</span> <span class="n">Ubuntu</span><span class="o">-</span><span class="mf">1804.</span><span class="n">appx</span> <span class="n">Ubuntu</span><span class="o">-</span><span class="mf">1804.</span><span class="n">zip</span>
<span class="n">Expand</span><span class="o">-</span><span class="n">Archive</span> <span class="n">Ubuntu</span><span class="o">-</span><span class="mf">1804.</span><span class="n">zip</span> <span class="n">Ubuntu</span><span class="o">-</span><span class="mi">1804</span>
<span class="n">cd</span> <span class="n">Ubuntu</span><span class="o">-</span><span class="mi">1804</span>
<span class="o">.</span>\<span class="n">ubuntu1804</span><span class="o">.</span><span class="n">exe</span>
</pre></div>
</div>
<p>This last command spawns a shell inside a Ubuntu distribution which is using WSL.</p>
<p>Documentation about WSL:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/wsl/install-win10">https://docs.microsoft.com/en-us/windows/wsl/install-win10</a>
Generic installation guide</p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-us/windows/wsl/install-on-server">https://docs.microsoft.com/en-us/windows/wsl/install-on-server</a>
Installation guide for servers</p></li>
<li><p><a class="reference external" href="https://docs.microsoft.com/en-gb/windows/wsl/release-notes">https://docs.microsoft.com/en-gb/windows/wsl/release-notes</a>
Release notes</p></li>
</ul>
</div>
<div class="section" id="software-to-install">
<h2>Software to install<a class="headerlink" href="#software-to-install" title="Permalink to this headline">¶</a></h2>
<div class="section" id="automatic-installation">
<h3>Automatic installation<a class="headerlink" href="#automatic-installation" title="Permalink to this headline">¶</a></h3>
<p>In order to ease the installation of software, a package manager such as
<a class="reference external" href="https://ninite.com/">Ninite</a> or <a class="reference external" href="https://chocolatey.org/">Chocolatey</a> can be
used (cf. <a class="reference external" href="https://chocolatey.org/docs/chocolatey-vs-ninite">https://chocolatey.org/docs/chocolatey-vs-ninite</a>).
Chocolatey’s website gives some installation commands
(<a class="reference external" href="https://chocolatey.org/docs/installation#install-with-cmdexe">https://chocolatey.org/docs/installation#install-with-cmdexe</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># For cmd.exe</span>
<span class="o">@</span><span class="s2">&quot;%SystemRoot%\System32\WindowsPowerShell</span><span class="se">\v</span><span class="s2">1.0\powershell.exe&quot;</span> <span class="o">-</span><span class="n">NoProfile</span> <span class="o">-</span><span class="n">InputFormat</span> <span class="kc">None</span> <span class="o">-</span><span class="n">ExecutionPolicy</span> <span class="n">Bypass</span> <span class="o">-</span><span class="n">Command</span> <span class="s2">&quot;iex ((New-Object System.Net.WebClient).DownloadString(&#39;https://chocolatey.org/install.ps1&#39;))&quot;</span> <span class="o">&amp;&amp;</span> <span class="n">SET</span> <span class="s2">&quot;PATH=%PATH%;%ALLUSERSPROFILE%\chocolatey</span><span class="se">\b</span><span class="s2">in&quot;</span>
<span class="c1"># For PowerShell</span>
<span class="n">Set</span><span class="o">-</span><span class="n">ExecutionPolicy</span> <span class="n">Bypass</span> <span class="o">-</span><span class="n">Scope</span> <span class="n">Process</span> <span class="o">-</span><span class="n">Force</span><span class="p">;</span> <span class="n">iex</span> <span class="p">((</span><span class="n">New</span><span class="o">-</span><span class="n">Object</span> <span class="n">System</span><span class="o">.</span><span class="n">Net</span><span class="o">.</span><span class="n">WebClient</span><span class="p">)</span><span class="o">.</span><span class="n">DownloadString</span><span class="p">(</span><span class="s1">&#39;https://chocolatey.org/install.ps1&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>Chocolatey adds itself to <code class="docutils literal notranslate"><span class="pre">%PATH%</span></code> environment variable, and this can be
verified in the registry:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">PS</span> <span class="n">C</span><span class="p">:</span>\<span class="o">&gt;</span> <span class="n">Get</span><span class="o">-</span><span class="n">ItemProperty</span> <span class="o">-</span><span class="n">Path</span> <span class="s1">&#39;Registry::HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\Session Manager\Environment&#39;</span> <span class="o">-</span><span class="n">Name</span> <span class="n">PATH</span>
<span class="c1"># It should ends with C:\ProgramData\chocolatey\bin;</span>

<span class="c1"># Or with cmd.exe:</span>
<span class="n">reg</span> <span class="n">query</span> <span class="s2">&quot;HKLM\System\CurrentControlSet\Control\Session Manager\Environment&quot;</span> <span class="o">/</span><span class="n">v</span> <span class="n">PATH</span>
</pre></div>
</div>
<p>Then, to install software:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">choco</span> <span class="n">install</span> <span class="n">notepadplusplus</span> <span class="n">notepadplusplus</span><span class="o">.</span><span class="n">commandline</span> <span class="o">-</span><span class="n">y</span>
<span class="n">choco</span> <span class="n">install</span> <span class="n">windbg</span> <span class="o">-</span><span class="n">y</span>
<span class="c1"># https://chocolatey.org/packages?q=sysinternals</span>
<span class="n">choco</span> <span class="n">install</span> <span class="n">procexp</span> <span class="n">procmon</span> <span class="n">autoruns</span> <span class="n">psexec</span> <span class="n">procdump</span> <span class="n">adexplorer</span> <span class="n">sigcheck</span> <span class="n">dbgview</span> <span class="n">winobj</span> <span class="n">accesschk</span> <span class="n">accessenum</span> <span class="o">-</span><span class="n">y</span>

<span class="c1"># MSys2 is installed in C:\tools\msys64</span>
<span class="n">choco</span> <span class="n">install</span> <span class="n">git</span> <span class="n">python3</span> <span class="n">msys2</span> <span class="o">-</span><span class="n">y</span>
<span class="c1"># Add &#39;PATH=&quot;$PATH:/c/Program Files/Git/cmd&quot;&#39; to C:/tools/msys64/home/IEUser/.bashrc</span>
<span class="c1"># Launch MSys with C:/tools/msys64/usr/bin/bash.exe</span>
</pre></div>
</div>
<p>These commands install the following software:</p>
<ul>
<li><p>Notepad++: <a class="reference external" href="https://notepad-plus-plus.org/">https://notepad-plus-plus.org/</a> (the sha1sums of the downloaded files can be verified)</p></li>
<li><p>Windows Development Kits, debugger (WinDbg…):</p>
<ul class="simple">
<li><p><a class="reference external" href="https://developer.microsoft.com/en-us/windows/hardware/windows-driver-kit">https://developer.microsoft.com/en-us/windows/hardware/windows-driver-kit</a></p></li>
<li><p>Create a shortcut to <code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files</span> <span class="pre">(x86)\Windows</span> <span class="pre">Kits\10\Debuggers\x64</span></code></p></li>
</ul>
</li>
<li><p>Some Sysinternals tools:</p>
<ul class="simple">
<li><p>Process Explorer <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/processexplorer">https://technet.microsoft.com/en-us/sysinternals/processexplorer</a></p></li>
<li><p>Process Monitor <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/processmonitor">https://technet.microsoft.com/en-us/sysinternals/processmonitor</a></p></li>
<li><p>DebugView <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/debugview">https://technet.microsoft.com/en-us/sysinternals/debugview</a></p></li>
<li><p>WinObj <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/winobj">https://technet.microsoft.com/en-us/sysinternals/winobj</a></p></li>
<li><p>AccessEnum <a class="reference external" href="https://technet.microsoft.com/en-us/sysinternals/accessenum">https://technet.microsoft.com/en-us/sysinternals/accessenum</a></p></li>
<li><p>etc.</p></li>
</ul>
</li>
<li><p>Git: <a class="reference external" href="https://git-scm.com/">https://git-scm.com/</a></p></li>
<li><p>Python: <a class="reference external" href="https://www.python.org/downloads/windows/">https://www.python.org/downloads/windows/</a></p></li>
<li><p>MSys2 environment: <a class="reference external" href="https://www.msys2.org/">https://www.msys2.org/</a>. Additional software like GCC
(to compile C programs) can be installed with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">c</span><span class="p">:</span>\<span class="n">tools</span>\<span class="n">msys64</span>\<span class="n">usr</span>\<span class="nb">bin</span>\<span class="n">bash</span><span class="o">.</span><span class="n">exe</span>
<span class="n">pacman</span> <span class="o">-</span><span class="n">Sy</span> <span class="n">base</span><span class="o">-</span><span class="n">devel</span> <span class="n">mingw</span><span class="o">-</span><span class="n">w64</span><span class="o">-</span><span class="n">x86_64</span><span class="o">-</span><span class="n">toolchain</span>
</pre></div>
</div>
</li>
</ul>
<p>In the end: reboot! (Remember that we are talking about Windows…)</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># &quot;Powershell Restart-Computer&quot; may also work</span>
<span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="o">-</span><span class="n">t</span> <span class="mi">0</span>
</pre></div>
</div>
</div>
<div class="section" id="debloat-windows">
<h3>Debloat Windows<a class="headerlink" href="#debloat-windows" title="Permalink to this headline">¶</a></h3>
<p>Windows 10 comes with many features which are better disabled. Here are some
websites describing them:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://github.com/W4RH4WK/Debloat-Windows-10">https://github.com/W4RH4WK/Debloat-Windows-10</a></p></li>
<li><p><a class="reference external" href="https://www.01net.com/actualites/comme-windows-10-windows-7-et-8-embarquent-des-mouchards-911343.html">https://www.01net.com/actualites/comme-windows-10-windows-7-et-8-embarquent-des-mouchards-911343.html</a></p></li>
</ul>
<p>Here are commands that can be issued once Git has been installed, in a
PowerShell administrator console:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">git</span> <span class="n">clone</span> <span class="n">https</span><span class="p">:</span><span class="o">//</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">W4RH4WK</span><span class="o">/</span><span class="n">Debloat</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="mi">10</span>
<span class="n">cd</span> <span class="n">Debloat</span><span class="o">-</span><span class="n">Windows</span><span class="o">-</span><span class="mi">10</span>\<span class="n">scripts</span>
<span class="o">.</span>\<span class="n">block</span><span class="o">-</span><span class="n">telemetry</span><span class="o">.</span><span class="n">ps1</span>
<span class="o">.</span>\<span class="n">disable</span><span class="o">-</span><span class="n">services</span><span class="o">.</span><span class="n">ps1</span>
<span class="c1"># .\disable-windows-defender.ps1</span>
<span class="c1"># .\experimental_unfuckery.ps1 # Uncomment some apps there</span>
<span class="o">.</span>\<span class="n">fix</span><span class="o">-</span><span class="n">privacy</span><span class="o">-</span><span class="n">settings</span><span class="o">.</span><span class="n">ps1</span>
<span class="o">.</span>\<span class="n">optimize</span><span class="o">-</span><span class="n">user</span><span class="o">-</span><span class="n">interface</span><span class="o">.</span><span class="n">ps1</span>
<span class="o">.</span>\<span class="n">optimize</span><span class="o">-</span><span class="n">windows</span><span class="o">-</span><span class="n">update</span><span class="o">.</span><span class="n">ps1</span>
<span class="o">.</span>\<span class="n">remove</span><span class="o">-</span><span class="n">default</span><span class="o">-</span><span class="n">apps</span><span class="o">.</span><span class="n">ps1</span>
<span class="o">.</span>\<span class="n">remove</span><span class="o">-</span><span class="n">onedrive</span><span class="o">.</span><span class="n">ps1</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">Windows Virtual Machine with Vagrant</a><ul>
<li><a class="reference internal" href="#create-a-libvirt-box">Create a Libvirt box</a></li>
<li><a class="reference internal" href="#first-configuration">First configuration</a></li>
<li><a class="reference internal" href="#remote-access">Remote access</a><ul>
<li><a class="reference internal" href="#rdp-connection">RDP connection</a></li>
<li><a class="reference internal" href="#using-winrm">Using WinRM</a></li>
<li><a class="reference internal" href="#install-windows-openssh-server">Install Windows OpenSSH server</a></li>
</ul>
</li>
<li><a class="reference internal" href="#enable-the-windows-subsystem-for-linux">Enable the Windows Subsystem for Linux</a></li>
<li><a class="reference internal" href="#software-to-install">Software to install</a><ul>
<li><a class="reference internal" href="#automatic-installation">Automatic installation</a></li>
<li><a class="reference internal" href="#debloat-windows">Debloat Windows</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="utc-clock.html"
                        title="previous chapter">Set hardware clock to UTC</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="windbg-kd.html"
                        title="next chapter">WinDbg-kd, Windows Kernel Debugging</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/windows/vagrant.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="windbg-kd.html" title="WinDbg-kd, Windows Kernel Debugging"
             >next</a> |</li>
        <li class="right" >
          <a href="utc-clock.html" title="Set hardware clock to UTC"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Generic Config</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Windows system information</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2019, Nicolas Iooss.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 2.0.1.
    </div>
  </body>
</html>