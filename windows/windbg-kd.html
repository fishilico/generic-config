
<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta charset="utf-8" />
    <title>WinDbg-kd, Windows Kernel Debugging &#8212; Generic Config</title>
    <link rel="stylesheet" href="../_static/nature.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <script id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/language_data.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Generic Configuration README" href="../README.html" />
    <link rel="prev" title="Some VBScript commands" href="vbscript.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../README.html" title="Generic Configuration README"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="vbscript.html" title="Some VBScript commands"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Generic Config</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" accesskey="U">Windows system information</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="windbg-kd-windows-kernel-debugging">
<h1>WinDbg-kd, Windows Kernel Debugging<a class="headerlink" href="#windbg-kd-windows-kernel-debugging" title="Permalink to this headline">¶</a></h1>
<p>To debug a Windows kernel, here is what is needed:</p>
<ul>
<li><p>WinDbg (for example with VisualStudio Express Edition)</p></li>
<li><p>A kernel booted in debug mode.  For local debugging, the boot can be
configured with these commands (on Windows&lt;=7, the second one fails but
WinDbg still supports local kernel debugging):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bcdedit</span> <span class="o">/</span><span class="n">debug</span> <span class="n">on</span>

<span class="c1"># Since Windows 8, otherwise debugging is enabled on serial port COM2</span>
<span class="n">bcdedit</span> <span class="o">/</span><span class="n">dbgsettings</span> <span class="n">local</span>
</pre></div>
</div>
</li>
</ul>
<p>(<code class="docutils literal notranslate"><span class="pre">bcdedit</span></code> configures the Boot Configuration Database)</p>
<p>It is then possible to run <code class="docutils literal notranslate"><span class="pre">windbg</span> <span class="pre">-kl</span></code> as administrator to start a Local
Kernel debugging session.</p>
<p>To verify whether local kernel debugging is enabled:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cd</span> <span class="n">C</span><span class="p">:</span>\<span class="n">Program</span> <span class="n">Files</span> <span class="p">(</span><span class="n">x86</span><span class="p">)</span>\<span class="n">Windows</span> <span class="n">Kits</span>\<span class="mi">10</span>\<span class="n">Debuggers</span>\<span class="n">x64</span>\
<span class="n">kdbgctrl</span> <span class="o">-</span><span class="n">c</span>
</pre></div>
</div>
<p>In order to configure kernel debugging on a virtual machine, it is possible to
use network debugging, with a key which consists in 3 words separated with dots:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">bcdedit</span> <span class="o">/</span><span class="n">dbgsettings</span> <span class="n">NET</span> <span class="n">HOSTIP</span><span class="p">:</span><span class="mf">172.16</span><span class="o">.</span><span class="mf">0.1</span> <span class="n">PORT</span><span class="p">:</span><span class="mi">50000</span> <span class="n">KEY</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">d</span>

<span class="c1"># On the debugger host (breaking happens in nt!DbgBreakPointWithStatus)</span>
<span class="n">WinDbg</span> <span class="o">-</span><span class="n">k</span> <span class="n">net</span><span class="p">:</span><span class="n">port</span><span class="o">=</span><span class="mi">52000</span><span class="p">,</span><span class="n">key</span><span class="p">:</span><span class="n">a</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">d</span><span class="p">,</span><span class="n">target</span><span class="p">:</span><span class="n">DESKTOP</span><span class="o">-</span><span class="n">AB01CDE</span>
</pre></div>
</div>
<p>To load kernel symbols, it is possible to download a Windows Symbol Package
from MSDN, but it is simpler to make WinDbg download them automatically.
This can be done either with an environment variable
(cf. <a class="reference external" href="https://support.microsoft.com/en-us/kb/311503">https://support.microsoft.com/en-us/kb/311503</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">_NT_SYMBOL_PATH</span><span class="o">=</span><span class="n">SRV</span><span class="o">*</span><span class="n">C</span><span class="p">:</span>\<span class="n">DebugSymbols</span><span class="o">*</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">msdl</span><span class="o">.</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">symbols</span>

<span class="c1"># To make it persistent:</span>
<span class="n">setx</span> <span class="n">_NT_SYMBOL_PATH</span> <span class="n">srv</span><span class="o">*</span><span class="n">C</span><span class="p">:</span>\<span class="n">DebugSymbols</span><span class="o">*</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">msdl</span><span class="o">.</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">symbols</span>
</pre></div>
</div>
<p>or with WinDbg commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">sympath</span> <span class="n">SRV</span><span class="o">*</span><span class="n">C</span><span class="p">:</span>\<span class="n">DebugSymbols</span><span class="o">*</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">msdl</span><span class="o">.</span><span class="n">microsoft</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">download</span><span class="o">/</span><span class="n">symbols</span>
<span class="o">.</span><span class="n">reload</span> <span class="o">/</span><span class="n">f</span>
</pre></div>
</div>
<div class="section" id="usual-commands">
<h2>Usual commands<a class="headerlink" href="#usual-commands" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Get help about a command: <code class="docutils literal notranslate"><span class="pre">.hh</span> <span class="pre">x</span></code> (examine), <code class="docutils literal notranslate"><span class="pre">.hh</span> <span class="pre">uu</span></code> (unassemble)</p></li>
<li><p>Examine symbols starting with <code class="docutils literal notranslate"><span class="pre">NtCreate</span></code> in the kernel: <code class="docutils literal notranslate"><span class="pre">x</span> <span class="pre">nt!NtCreate*</span></code>.</p></li>
<li><p>Display values at an address, with optional argument <code class="docutils literal notranslate"><span class="pre">L</span> <span class="pre">size</span></code>:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">db</span></code>: display hexadecimal bytes (128 by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dc</span></code>: display DWORD values and their ASCII equivalents (32 by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dd</span></code>: display DWORD values (32 by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dp</span></code>: display ULONG_PTR values (128 bytes by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dps</span></code>: display pointers and symbols (<code class="docutils literal notranslate"><span class="pre">dp</span></code> with symbols)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dpp</span></code>: like <code class="docutils literal notranslate"><span class="pre">dps</span></code>, with an extra pointer dereference</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dq</span></code>: display ULONG64_PTR values (128 bytes by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">du</span></code>: display UNICODE characters values (16 2-byte characters by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dw</span></code>: display WORD values (64 by default)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ds</span> <span class="pre">/c</span> <span class="pre">width</span> <span class="pre">addr</span></code>: display width characters at addr</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">dS</span> <span class="pre">/c</span> <span class="pre">width</span> <span class="pre">addr</span></code>: display width unicode characters at addr</p></li>
</ul>
</li>
<li><p>Disassemble the beginning of a function (use <code class="docutils literal notranslate"><span class="pre">L2a</span></code> to show 42 instructions):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; u nt!KiSystemCall64
nt!KiSystemCall64:
fffff800`29f9d040 0f01f8          swapgs
fffff800`29f9d043 654889242510000000 mov   qword ptr gs:[10h],rsp
fffff800`29f9d04c 65488b2425a8010000 mov   rsp,qword ptr gs:[1A8h]
fffff800`29f9d055 6a2b            push    2Bh
fffff800`29f9d057 65ff342510000000 push    qword ptr gs:[10h]
fffff800`29f9d05f 4153            push    r11
fffff800`29f9d061 6a33            push    33h
fffff800`29f9d063 51              push    rcx
</pre></div>
</div>
</li>
<li><p>Display the types of fields of a structure: <code class="docutils literal notranslate"><span class="pre">dt</span> <span class="pre">nt!_KUSER_SHARED_DATA</span></code></p></li>
</ul>
</div>
<div class="section" id="system-related-commands">
<h2>System-related commands<a class="headerlink" href="#system-related-commands" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>List modules with names and timestamps: <code class="docutils literal notranslate"><span class="pre">lm</span> <span class="pre">n</span> <span class="pre">t</span></code></p></li>
<li><p>List some information about the kernel: <code class="docutils literal notranslate"><span class="pre">!lmi</span> <span class="pre">nt</span></code></p></li>
<li><p>Read the PCR (Processor Control Region): <code class="docutils literal notranslate"><span class="pre">!pcr</span></code></p></li>
<li><p>Read the PRCB (Processor Control Block): <code class="docutils literal notranslate"><span class="pre">!prbc</span></code></p></li>
<li><p>Get information about the current machine: <code class="docutils literal notranslate"><span class="pre">!sysinfo</span> <span class="pre">machineid</span></code></p></li>
<li><p>Display information about a process and set it to be the current one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; !process 0 0 explorer.exe
PROCESS ffff9702a7995080
    SessionId: 1  Cid: 0bbc    Peb: 0020f000  ParentCid: 0b7c
    DirBase: 3eaf7000  ObjectTable: ffff820ba5bcc8c0  HandleCount: &lt;Data Not Accessible&gt;
    Image: explorer.exe

lkd&gt; .process /P ffff9702a7995080
Implicit process is now ffff9702`a7995080
</pre></div>
</div>
</li>
<li><p>Read the PEB (Process Environment Block) of the current process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; !peb
PEB at 000000000020f000
    InheritedAddressSpace:    No
    ReadImageFileExecOptions: No
    BeingDebugged:            No
    ImageBaseAddress:         00007ff773fe0000
    Ldr                       00007ffdf0c623a0
    Ldr.Initialized:          Yes
    Ldr.InInitializationOrderModuleList: 0000000000652270 . 000000000b1c7f00
    Ldr.InLoadOrderModuleList:           00000000006523e0 . 000000000b1c7ee0
    Ldr.InMemoryOrderModuleList:         00000000006523f0 . 000000000b1c7ef0
                    Base TimeStamp                     Module
            7ff773fe0000 57a449e4 Aug 05 01:10:12 2016 C:\Windows\Explorer.EXE
            7ffdf0b10000 57a447be Aug 05 01:01:02 2016 C:\Windows\SYSTEM32\ntdll.dll
            7ffdee620000 57a44ac4 Aug 05 01:13:56 2016 C:\Windows\System32\KERNEL32.DLL
            7ffded2a0000 57a447cc Aug 05 01:01:16 2016 C:\Windows\System32\KERNELBASE.dll
            7ffdf0920000 57a44d8f Aug 05 01:25:51 2016 C:\Windows\System32\msvcrt.dll
            7ffdee500000 57a44c17 Aug 05 01:19:35 2016 C:\Windows\System32\OLEAUT32.dll
            7ffdede80000 57a44804 Aug 05 01:02:12 2016 C:\Windows\System32\ucrtbase.dll
            7ffdeefc0000 57a448db Aug 05 01:05:47 2016 C:\Windows\System32\combase.dll
...
            7ffde0670000 57a449c1 Aug 05 01:09:37 2016 C:\Windows\SYSTEM32\CHARTV.dll
    SubSystemData:     00007ffdebb40e30
    ProcessHeap:       0000000000650000
    ProcessParameters: 0000000000651a50
    CurrentDirectory:  &#39;C:\Windows\system32\&#39;
    WindowTitle:  &#39;Microsoft.Windows.Explorer&#39;
    ImageFile:    &#39;C:\Windows\Explorer.EXE&#39;
    CommandLine:  &#39;C:\Windows\Explorer.EXE&#39;
    DllPath:      &#39;&lt; Name not readable &gt;&#39;
    Environment:  000000000b0361f0
        ALLUSERSPROFILE=C:\ProgramData
        APPDATA=C:\Users\IEUser\AppData\Roaming
        ChocolateyInstall=C:\ProgramData\chocolatey
        ChocolateyLastPathUpdate=Wed Aug 10 11:06:58 2016
        CommonProgramFiles=C:\Program Files\Common Files
        CommonProgramFiles(x86)=C:\Program Files (x86)\Common Files
        CommonProgramW6432=C:\Program Files\Common Files
        COMPUTERNAME=MSEDGEWIN10
        ComSpec=C:\Windows\system32\cmd.exe
...
        PUBLIC=C:\Users\Public
        SESSIONNAME=Console
        SystemDrive=C:
        SystemRoot=C:\Windows
        TEMP=C:\Users\IEUser\AppData\Local\Temp
        TMP=C:\Users\IEUser\AppData\Local\Temp
        USERDOMAIN=MSEDGEWIN10
        USERDOMAIN_ROAMINGPROFILE=MSEDGEWIN10
        USERNAME=IEUser
        USERPROFILE=C:\Users\IEUser
        windir=C:\Windows
</pre></div>
</div>
</li>
<li><p>Dump the virtual memory allocations of the current process:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; !vad
VAD             level      start      end    commit
ffff9702a7812b10 ( 8)         200       3ff       145 Private      READWRITE
ffff9702a7985420 ( 7)         400       40f         0 Mapped       READWRITE          Pagefile-backed section
ffff9702a798a880 ( 8)         410       416         6 Private      READWRITE
ffff9702a7982360 ( 6)         420       435         0 Mapped       READONLY           Pagefile-backed section
ffff9702a7955100 ( 7)         440       4bf        23 Private      READWRITE
ffff9702a7986010 ( 8)         4c0       4c3         0 Mapped       READONLY           Pagefile-backed section
ffff9702a7980230 ( 5)         4d0       4d1         0 Mapped       READONLY           Pagefile-backed section
ffff9702a78fa380 ( 8)         4e0       4e1         2 Private      READWRITE
ffff9702a798b8c0 ( 7)         4f0       5b0         0 Mapped       READONLY           \Windows\System32\locale.nls
ffff9702a66adbf0 ( 8)         5c0       5cc        13 Private      READWRITE
ffff9702a5f53f70 ( 9)         5d0       5d2         3 Private      READWRITE
ffff9702a8103700 ( 6)         5e0       5e6         0 Mapped       READONLY           \Windows\System32\en-US\explorerframe.dll.mui
ffff9702a76fe800 ( 8)         5f0       5f1         0 Mapped       READONLY           Pagefile-backed section
ffff9702a7ecb6c0 ( 9)         600       600         1 Private      READWRITE
ffff9702a7fa5090 ( 7)         610       613         4 Private      READWRITE
ffff9702a7ded0a0 ( 9)         620       623         4 Private      READWRITE
ffff9702a7dee2f0 ( 8)         630       633         4 Private      READWRITE
ffff9702a7978850 ( 9)         640       641         0 Mapped       READONLY           Pagefile-backed section
ffff9702a7750880 ( 4)         650       74f       255 Private      READWRITE
...
</pre></div>
</div>
<p>(Append <code class="docutils literal notranslate"><span class="pre">000</span></code> to <code class="docutils literal notranslate"><span class="pre">start</span></code> and <code class="docutils literal notranslate"><span class="pre">end</span></code> to get real addresses, usable with <code class="docutils literal notranslate"><span class="pre">dd</span></code>)</p>
</li>
<li><p>Dump the System Service Table (SSDT): <code class="docutils literal notranslate"><span class="pre">dps</span> <span class="pre">nt!KiServiceTable</span> <span class="pre">L11c</span></code></p></li>
<li><p>Dump system protected processes (cf. <a class="reference external" href="http://www.alex-ionescu.com/?p=116">http://www.alex-ionescu.com/?p=116</a>):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; !for_each_process &quot;
r? @$t0 = (nt!_EPROCESS*) @#Process;
.if @@(@$t0-&gt;Protection.Level) {
    .printf /D \&quot;%08x &lt;b&gt;[%70msu]&lt;/b&gt; level: &lt;b&gt;%02x&lt;/b&gt;\\n\&quot;,
        @@(@$t0-&gt;UniqueProcessId),
        @@(&amp;@$t0-&gt;SeAuditProcessCreationInfo.ImageFileName-&gt;Name),
        @@(@$t0-&gt;Protection.Level)
}&quot;
00000004 [                                                                      ] level: 62
00000148 [                     \Device\HarddiskVolume2\Windows\System32\smss.exe] level: 61
000001a8 [                    \Device\HarddiskVolume2\Windows\System32\csrss.exe] level: 61
000001e4 [                  \Device\HarddiskVolume2\Windows\System32\wininit.exe] level: 61
000001ec [                    \Device\HarddiskVolume2\Windows\System32\csrss.exe] level: 61
00000268 [                 \Device\HarddiskVolume2\Windows\System32\services.exe] level: 61
0000037c [    \Device\HarddiskVolume2\Program Files\Windows Defender\MsMpEng.exe] level: 31
</pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="x86-specific-commands">
<h2>x86-specific commands<a class="headerlink" href="#x86-specific-commands" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p>Dump the Interrupt Descriptor Table, which contains Interrupt Service Routines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; !idt

Dumping IDT: fffff8002b8e4080

00: fffff80029f9aa00 nt!KiDivideErrorFault
01: fffff80029f9ab00 nt!KiDebugTrapOrFault
02: fffff80029f9acc0 nt!KiNmiInterrupt  Stack = 0xFFFFF8002B8FF000
03: fffff80029f9b040 nt!KiBreakpointTrap
04: fffff80029f9b140 nt!KiOverflowTrap
05: fffff80029f9b240 nt!KiBoundFault
06: fffff80029f9b340 nt!KiInvalidOpcodeFault
07: fffff80029f9b580 nt!KiNpxNotAvailableFault
08: fffff80029f9b640 nt!KiDoubleFaultAbort  Stack = 0xFFFFF8002B8FD000
09: fffff80029f9b700 nt!KiNpxSegmentOverrunAbort
0a: fffff80029f9b7c0 nt!KiInvalidTssFault
0b: fffff80029f9b880 nt!KiSegmentNotPresentFault
0c: fffff80029f9b9c0 nt!KiStackFault
0d: fffff80029f9bb00 nt!KiGeneralProtectionFault
0e: fffff80029f9bc00 nt!KiPageFault
10: fffff80029f9bfc0 nt!KiFloatingErrorFault
11: fffff80029f9c140 nt!KiAlignmentFault
12: fffff80029f9c240 nt!KiMcheckAbort   Stack = 0xFFFFF8002B901000
13: fffff80029f9c8c0 nt!KiXmmException
1f: fffff80029f964a0 nt!KiApcInterrupt
20: fffff80029f99fc0 nt!KiSwInterrupt
29: fffff80029f9ca80 nt!KiRaiseSecurityCheckFailure
2c: fffff80029f9cb80 nt!KiRaiseAssertion
2d: fffff80029f9cc80 nt!KiDebugServiceTrap
2f: fffff80029f96770 nt!KiDpcInterrupt
30: fffff80029f969a0 nt!KiHvInterrupt
31: fffff80029f96d10 nt!KiVmbusInterrupt0
32: fffff80029f97070 nt!KiVmbusInterrupt1
33: fffff80029f973d0 nt!KiVmbusInterrupt2
34: fffff80029f97730 nt!KiVmbusInterrupt3
35: fffff80029e53090 hal!HalpInterruptCmciService (KINTERRUPT fffff80029e53000)
50: ffffd0017e709bd0 ataport!IdePortInterrupt (KINTERRUPT ffffd0017e709b40)
60: ffffd0017e709d10 ataport!IdePortInterrupt (KINTERRUPT ffffd0017e709c80)
80: ffffd0017e709810 i8042prt!I8042MouseInterruptService (KINTERRUPT ffffd0017e709780)
81: ffffd0017e709590 ndis!ndisMiniportIsr (KINTERRUPT ffffd0017e709500)
90: ffffd0017e7096d0 i8042prt!I8042KeyboardInterruptService (KINTERRUPT ffffd0017e709640)
91: ffffd0017e709310 USBPORT!USBPORT_InterruptService (KINTERRUPT ffffd0017e709280)
a0: ffffd0017e7091d0 serial!SerialCIsrSw (KINTERRUPT ffffd0017e709140)
b0: ffffd0017e709e50 ACPI!ACPIInterruptServiceRoutine (KINTERRUPT ffffd0017e709dc0)
b1: ffffd0017e709a90 storport!RaidpAdapterInterruptRoutine (KINTERRUPT ffffd0017e709a00)
                     HDAudBus!HdaController::Isr (KINTERRUPT ffffd0017e7093c0)
ce: fffff80029e53a90 hal!HalpIommuInterruptRoutine (KINTERRUPT fffff80029e53a00)
d1: fffff80029e53890 hal!HalpTimerClockInterrupt (KINTERRUPT fffff80029e53800)
d2: fffff80029e53790 hal!HalpTimerClockIpiRoutine (KINTERRUPT fffff80029e53700)
d7: fffff80029e53590 hal!HalpInterruptRebootService (KINTERRUPT fffff80029e53500)
d8: fffff80029e53390 hal!HalpInterruptStubService (KINTERRUPT fffff80029e53300)
df: fffff80029e53290 hal!HalpInterruptSpuriousService (KINTERRUPT fffff80029e53200)
e1: fffff80029f97aa0 nt!KiIpiInterrupt
e2: fffff80029e53490 hal!HalpInterruptLocalErrorService (KINTERRUPT fffff80029e53400)
e3: fffff80029e53190 hal!HalpInterruptDeferredRecoveryService (KINTERRUPT fffff80029e53100)
fd: fffff80029e53990 hal!HalpTimerProfileInterrupt (KINTERRUPT fffff80029e53900)
fe: fffff80029e53690 hal!HalpPerfInterrupt (KINTERRUPT fffff80029e53600)
</pre></div>
</div>
</li>
<li><p>Read a MSR register, like STAR (syscall target):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; rdmsr c0000082
msr[c0000082] = fffff800`29f9d040
kd&gt; u fffff800`29f9d040 L1
nt!KiSystemCall64:
fffff800`29f9d040 0f01f8          swapgs
</pre></div>
</div>
</li>
<li><p>To get the Kernel Processor Control Region (KPCR), use <code class="docutils literal notranslate"><span class="pre">fs_base</span></code> MSR
(0xc0000100) on x86-32 and <code class="docutils literal notranslate"><span class="pre">gs_base</span></code> (0xc0000101) on x86-64:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; rdmsr c0000101
msr[c0000101] = ffffd001`aef40000
lkd&gt; dt nt!_KPCR ffffd001aef40000
</pre></div>
</div>
</li>
<li><p>The GDT (Global Descriptor Table) can be read by a remote debugger with
<code class="docutils literal notranslate"><span class="pre">r</span> <span class="pre">gdtr</span></code> and the detail of each descriptors can be seen with commands such
as <code class="docutils literal notranslate"><span class="pre">dp</span> <span class="pre">&#64;cs</span></code>.  When using a local debugger, it is nevertheless possible to
compile a userland program which shows the result of <code class="docutils literal notranslate"><span class="pre">sgdt</span></code> instruction,
which is not privileged, and then use the pointer in WinDBG with
<code class="docutils literal notranslate"><span class="pre">nt!_KGDTENTRY</span></code> (or <code class="docutils literal notranslate"><span class="pre">nt!_KGDTENTRY64</span></code>) structure.</p></li>
</ul>
</div>
<div class="section" id="natvis-and-javascript-since-windows-10">
<h2>NatVis and JavaScript (since Windows 10)<a class="headerlink" href="#natvis-and-javascript-since-windows-10" title="Permalink to this headline">¶</a></h2>
<p>Since Windows 10, WinDbg supports NatVis (Native Visualization, which was added
to Visual Studio 2013).</p>
<p>This allows such a syntax to dump a structure such as an <code class="docutils literal notranslate"><span class="pre">EPROCESS</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>lkd&gt; dx *(nt!_EPROCESS**)&amp;nt!PsInitialSystemProcess
*(nt!_EPROCESS**)&amp;nt!PsInitialSystemProcess                 : 0xffff9c8708c83040 [Type: _EPROCESS *]
    [+0x000] Pcb              [Type: _KPROCESS]
    [+0x2e0] ProcessLock      [Type: _EX_PUSH_LOCK]
    [+0x2e8] UniqueProcessId  : 0x4 [Type: void *]
    [+0x2f0] ActiveProcessLinks [Type: _LIST_ENTRY]
    [+0x300] RundownProtect   [Type: _EX_RUNDOWN_REF]
...
</pre></div>
</div>
<p>NatVis files are in <code class="docutils literal notranslate"><span class="pre">C:\Program</span> <span class="pre">Files</span> <span class="pre">(x86)\Windows</span> <span class="pre">Kits\10\Debuggers\x64\Visualizers</span></code>
(for example there is <code class="docutils literal notranslate"><span class="pre">stl.natvis</span></code> in order to represent types such as
<code class="docutils literal notranslate"><span class="pre">std::string</span></code>, <code class="docutils literal notranslate"><span class="pre">std::list</span></code>, <code class="docutils literal notranslate"><span class="pre">std::map</span></code>, etc.)</p>
<p>NatVis commands:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Define variables</span>
dx @<span class="nv">$myVar</span> <span class="o">=</span> <span class="s2">&quot;My sttring&quot;</span>
dx @<span class="nv">$myVar</span>
dx @<span class="nv">$myVar</span>.Length

<span class="c1"># Show methods</span>
dx -v @<span class="nv">$myVar</span>

<span class="c1"># Show a variable with 2 levels of recursion</span>
dx -r2 @<span class="nv">$myVar</span>

<span class="c1"># Create an array from memory</span>
dx @<span class="nv">$testArray</span> <span class="o">=</span> <span class="o">(</span>int<span class="o">(</span>*<span class="o">)[</span><span class="m">10</span><span class="o">])</span>0x7ffe0010
dx @<span class="nv">$testPointersArray</span> <span class="o">=</span> <span class="o">(</span>int*<span class="o">(</span>**<span class="o">)[</span><span class="m">10</span><span class="o">])</span>0x7ffe0010

<span class="c1"># Copy a variable into some memory</span>
dx *<span class="o">(</span>TYPE*<span class="o">)</span><span class="nv">0x10000</span> <span class="o">=</span> *@<span class="nv">$myNewContent</span>

<span class="c1"># Show the processor blocks</span>
dx <span class="o">(</span>nt!_KPRCB**<span class="o">)</span><span class="p">&amp;</span>nt!KiProcessorBlock, <span class="o">[</span>*<span class="o">(</span>int*<span class="o">)</span><span class="p">&amp;</span>nt!KeNumberProcessors<span class="o">]</span>

<span class="c1"># Enumerate all variables</span>
dx @<span class="nv">$vars</span>

<span class="c1"># Remove a variable</span>
@<span class="nv">$vars</span>.Remove<span class="o">(</span><span class="s2">&quot;myVar&quot;</span><span class="o">)</span>

<span class="c1"># Create an anonymous structure</span>
dx @<span class="nv">$myobject</span> <span class="o">=</span> new <span class="o">{</span> <span class="nv">Type</span> <span class="o">=</span> <span class="m">5</span>, <span class="nv">Name</span> <span class="o">=</span> <span class="s2">&quot;Process Object&quot;</span> <span class="o">}</span>

<span class="c1"># Create a new function (with anonymous function syntax)</span>
dx @<span class="nv">$mul</span> <span class="o">=</span> <span class="o">(</span>num1, num2<span class="o">)</span> <span class="o">=</span>&gt; num * num2

<span class="c1"># Load a NatVis file</span>
.nvload C:<span class="se">\p</span>ath<span class="se">\t</span>o<span class="se">\m</span>yfile.natvis
</pre></div>
</div>
<p>In WinDbg, there are 3 default NatVis variables: <code class="docutils literal notranslate"><span class="pre">&#64;$curprocess</span></code>,
<code class="docutils literal notranslate"><span class="pre">&#64;$curthread</span></code> and <code class="docutils literal notranslate"><span class="pre">&#64;$cursession</span></code>:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>lkd&gt; dx @<span class="nv">$cursession</span>
@<span class="nv">$cursession</span>                 : Local KD
    Processes
    Devices

lkd&gt; dx @<span class="nv">$cursession</span>.Processes
@<span class="nv">$cursession</span>.Processes
    <span class="o">[</span>0x0<span class="o">]</span>            : &lt;Unknown Image&gt;
    <span class="o">[</span>0x4<span class="o">]</span>            : &lt;Unknown Image&gt;
    <span class="o">[</span>0x38<span class="o">]</span>           : &lt;Unknown Image&gt;
    <span class="o">[</span>0x68<span class="o">]</span>           : &lt;Unknown Image&gt;
    <span class="o">[</span>0x1bc<span class="o">]</span>          : smss.exe
</pre></div>
</div>
<p>With LINQ (Language INtegrated Query) it is possible to process results using
SQL-like functions:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="c1"># Find processes named smss.exe</span>
dx @<span class="nv">$cursession</span>.Processes.Where<span class="o">(</span><span class="nv">p</span><span class="o">=</span>&gt;p.Name <span class="o">==</span> <span class="s2">&quot;smss.exe&quot;</span><span class="o">)</span>

<span class="c1"># Get the name of the process</span>
dx @<span class="nv">$cursession</span>.Processes.Where<span class="o">(</span><span class="nv">p</span><span class="o">=</span>&gt;p.Name <span class="o">==</span> <span class="s2">&quot;csrss.exe&quot;</span><span class="o">)</span>.First<span class="o">()</span>
    .KernelObject.SeAuditProcessCreationInfo.ImageFileName-&gt;Name

<span class="c1"># List processes with their protection levels</span>
dx -g @<span class="nv">$cursession</span>.Processes.Where<span class="o">(</span><span class="nv">p</span><span class="o">=</span>&gt;p.KernelObject.Protection.Level !<span class="o">=</span> <span class="m">0</span><span class="o">)</span>
    .Select<span class="o">(</span><span class="nv">p</span> <span class="o">=</span>&gt; new<span class="o">{</span><span class="nv">name</span><span class="o">=</span>p.Name, <span class="nv">Level</span><span class="o">=</span>p.KernelObject.Protection.Level<span class="o">})</span>

<span class="c1"># Get the names of handles opened by csrss</span>
dx -r2 @<span class="nv">$cursession</span>.Processes.Where<span class="o">(</span><span class="nv">p</span><span class="o">=</span>&gt;p.Name<span class="o">==</span><span class="s2">&quot;csrss.exe&quot;</span><span class="o">)</span>.Select<span class="o">(</span>
    <span class="nv">p</span> <span class="o">=</span>&gt; p.Io.Handles.Select<span class="o">(</span><span class="nv">h</span> <span class="o">=</span>&gt; h.ObjectName<span class="o">))</span>
</pre></div>
</div>
<p>In order to build complex structures from data, there are some helpers:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>dx -r0 @<span class="nv">$processList</span> <span class="o">=</span> *<span class="o">(</span>nt!_LIST_ENTRY*<span class="o">)</span><span class="p">&amp;</span>nt!PsActiveProcessHead
dx -r0 @<span class="nv">$processes</span> <span class="o">=</span> Debugger.Utility.Collections.FromListEntry<span class="o">(</span>
    @<span class="nv">$processList</span>, <span class="s2">&quot;nt!_EPROCESS&quot;</span>, <span class="s2">&quot;ActiveProcessLinks&quot;</span><span class="o">)</span>

dx Debugger.Utility.Control.ExecuteCommand<span class="o">(</span><span class="s2">&quot;!filetime 0&quot;</span><span class="o">)</span>.First<span class="o">()</span>
</pre></div>
</div>
<p>Using JavaScript provider:</p>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>.load jsprovider.dll

<span class="c1"># call initializeScript()</span>
.scriptload C:<span class="se">\p</span>ath<span class="se">\t</span>o<span class="se">\M</span>yScriptName.js

<span class="c1"># like .scriptload and call invokeScript()</span>
.scriptrun C:<span class="se">\p</span>ath<span class="se">\t</span>o<span class="se">\M</span>yScriptName.js

dx Debugger.State.Scripts.MyScriptName.Contents.my_function<span class="o">(</span>args<span class="o">)</span>
dx @<span class="nv">$scripts</span>.MyScriptName.Contents.my_function<span class="o">(</span>args<span class="o">)</span>
dx @<span class="nv">$scriptContents</span>.my_function<span class="o">(</span>args<span class="o">)</span>

<span class="c1"># call uninitializeScript() and unload</span>
.scriptunload MyScriptName.js
</pre></div>
</div>
<p>In JavaScript:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">host</span></code> is a COM object for the Degugger</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">host.memory</span></code> represents the target memory (method
<code class="docutils literal notranslate"><span class="pre">readMemoryValues(ptr,</span> <span class="pre">size)</span></code> returns an <code class="docutils literal notranslate"><span class="pre">ArrayBuffer</span></code> with memory)</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">host.diagnostics.debugLog(&quot;...&quot;)</span></code> prints logs</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">host.typeSystem.marshalAs(variable,</span> <span class="pre">&quot;nt&quot;,</span> <span class="pre">&quot;SOME_TYPE&quot;)</span></code> to cast</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">new</span> <span class="pre">host.metadata.valueWithMetadata(myInteger,</span> <span class="pre">{PreferredRadix:10})</span></code> to
print an integer as decimal</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">host.evaluateExpression(expr)</span></code> or <code class="docutils literal notranslate"><span class="pre">host.namespace.Debugger.Utility.Control.ExecuteCommand</span></code>
to run a debugger command (like <code class="docutils literal notranslate"><span class="pre">.printf</span> <span class="pre">%y</span></code> to convert a pointer to a
symbol using MASM syntax)</p></li>
</ul>
<p>To add new aliases in Javascript:</p>
<div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="n">function</span> <span class="nf">initializeScript</span><span class="p">()</span>
<span class="p">{</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">new</span> <span class="n">host</span><span class="p">.</span><span class="n">functionAlias</span><span class="p">(</span><span class="n">my_function</span><span class="p">,</span> <span class="s">&quot;myfct&quot;</span><span class="p">)</span> <span class="cm">/*, ... */</span><span class="p">];</span>
<span class="p">}</span>
<span class="c1">// In WinDBG:</span>
<span class="c1">//   !myfct arg1, arg2</span>
<span class="c1">//   dx @$myfct(arg1, arg2)</span>
</pre></div>
</div>
</div>
<div class="section" id="links">
<h2>Links<a class="headerlink" href="#links" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><a class="reference external" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff551063(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/hardware/ff551063(v=vs.85).aspx</a>
Debugging Tools for Windows (WinDbg, KD, CDB, NTSD)</p></li>
<li><p><a class="reference external" href="https://msdn.microsoft.com/en-us/windows/hardware/gg463028">https://msdn.microsoft.com/en-us/windows/hardware/gg463028</a>
Download Windows Symbol Packages</p></li>
<li><p><a class="reference external" href="https://msdn.microsoft.com/en-us/library/windows/hardware/ff551891(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/hardware/ff551891(v=vs.85).aspx</a>
Debugger Commands - Kernel-Mode Extensions</p></li>
<li><p><a class="reference external" href="http://windbg.info/doc/1-common-cmds.html">http://windbg.info/doc/1-common-cmds.html</a>
Common WinDbg Commands</p></li>
<li><p><a class="reference external" href="https://github.com/microsoft/WinDbg-Samples">https://github.com/microsoft/WinDbg-Samples</a>
Sample extensions, scripts, and API uses for WinDbg</p></li>
</ul>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">WinDbg-kd, Windows Kernel Debugging</a><ul>
<li><a class="reference internal" href="#usual-commands">Usual commands</a></li>
<li><a class="reference internal" href="#system-related-commands">System-related commands</a></li>
<li><a class="reference internal" href="#x86-specific-commands">x86-specific commands</a></li>
<li><a class="reference internal" href="#natvis-and-javascript-since-windows-10">NatVis and JavaScript (since Windows 10)</a></li>
<li><a class="reference internal" href="#links">Links</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="vbscript.html"
                        title="previous chapter">Some VBScript commands</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="../README.html"
                        title="next chapter">Generic Configuration README</a></p>
  <h3>This Page</h3>
  <ul class="this-page-menu">
    <li><a href="../_sources/windows/windbg-kd.rst.txt"
           rel="nofollow">Show Source</a></li>
    <li><a href="https://github.com/fishilico/generic-config/blob/master/windows/windbg-kd.rst"
           rel="nofollow">Show Source on GitHub
           <img src="../_static/GitHub-Mark-32px.png" style="width: 1.5em; border: none;" alt="" />
           </a></li>
  </ul>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../README.html" title="Generic Configuration README"
             >next</a> |</li>
        <li class="right" >
          <a href="vbscript.html" title="Some VBScript commands"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Generic Config</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="index.html" >Windows system information</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2013-2019, Nicolas Iooss.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.0.
    </div>
  </body>
</html>