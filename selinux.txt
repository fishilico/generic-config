Some notes about my SELinux installation
----------------------------------------

This document doesn't document how to install SELinux. If you want to install
it, please read one of these websites:
* https://wiki.debian.org/SELinux
* https://wiki.gentoo.org/wiki/SELinux/Tutorials
* https://fedoraproject.org/wiki/SELinux

Other websites useful to be bookmarked:
* http://oss.tresys.com/docs/refpolicy/api/ (reference policy API)
* https://wiki.gentoo.org/wiki/Project:SELinux/Development
* http://www.selinuxproject.org/page/ObjectClassesPerms
* http://git.overlays.gentoo.org/gitweb/?p=proj/hardened-refpolicy.git;a=summary


Install a strict policy
-----------------------

On Debian by default a targeted policy is installed: daemons are confined but
not user. To make users confined, you need to remove the unconfined module.
To do this:
* Set up staff accounts
    semanage login -a -s staff_u userlogin
* Confine users
    semanage login -m -s user_u -r s0 __default__
* Map root to root instead of unconfined_u
    semanage login -m -s root root
* Remove the module
    semodule -r unconfined


Fix /tmp labeling
-----------------

If mount shows:
    tmpfs on /tmp type tmpfs (rw,nosuid,nodev,relatime,rootcontext=system_u:object_r:file_t:s0,seclabel)
... or if ls -Zd /tmp shows:
    system_u:object_r:file_t:SystemLow /tmp
... the filesystem is labeled incorrectly.

To fix this bug, you need to restore the context of the /tmp folder of the root
filesystem to system_u:object_r:tmpfs_t:s0:
    mount --bind / /mnt
    setfiles -r /mnt /etc/selinux/default/contexts/files/file_contexts /mnt
    umount /mnt

Also update /etc/fstab to have this line:
    tmpfs /tmp tmpfs nodev,nosuid,rootcontext=system_u:object_r:tmp_t:s0 0 0


Configure SELinux booleans
--------------------------

    setsebool -P user_ping on

Enable reading of urandom for all domains:
    setsebool -P global_ssp on

If you have CGI on your webserver (gitweb for example) you need to set:
    setsebool -P httpd_enable_cgi on
    setsebool -P nginx_enable_http_server on

Fix labels for files in /home
-----------------------------

    semanage fcontext -a -t var_t "/home/git(/.*)?"


Activate some SELinux modules
-----------------------------

To reload modules, go to /usr/share/selinux/$(policyname) and run:
    semodule --verbose -b base.pp -s $(basename $(pwd)) -n -i module1.pp -i ...

Here are the modules from the Reference policy which are active on my Debian desktop system:
    accountsd
    apache
    application
    apt
    authlogin
    avahi
    clock
    consolekit
    cron
    dbus
    devicekit
    dhcp
    dmidecode
    dnsmasq
    dpkg
    fstools
    ftp
    getty
    git
    gpg
    gpm
    hddtemp
    hostname
    hotplug
    init
    iptables
    lda
    libraries
    loadkeys
    locallogin
    logging
    logrotate
    lpd
    lvm
    miscfiles
    modutils
    mount
    mozilla
    mpd
    mplayer
    mta
    netlabel
    netutils
    networkmanager
    nginx
    ntp
    policykit
    postfix
    postgresql
    pulseaudio
    pythonsupport
    radvd
    remotelogin
    rsync
    rtkit
    screen
    selinuxutil
    setrans
    ssh
    staff
    storage
    sudo
    sysadm
    sysnetwork
    timidity
    tzdata
    udev
    unprivuser
    usbmodules
    usbmuxd
    userdomain
    usermanage
    vbetool
    wireshark
    wm
    xscreensaver
    xserver


Other configuration
-------------------

Allow staff_u to read /root when running sudo.
By default /etc/selinux/default/modules/active/file_contexts.homedirs defines
/root to be labeled root:object_r:user_home_t, which staff_u can't access.
    chcon -u staff_u /root -R


Bugs still present in August 2013
---------------------------------

The reference policy is not so much up to date so it needs to be patched to
work correctly. For example, to use sudo, you need to do this:

    semanage fcontext -a -t pam_var_run_t "/var/((db)|(lib)|(adm))/sudo(/.*)?"
    restorecon -R -v /var/lib/sudo
    semanage fcontext -a -t shell_exec_t "/usr/lib/sudo/sesh"
    restorecon -v /usr/lib/sudo/sesh

When a rule is missing in the reference policy and you see a denied in audit
log, you need to create a new module and compile and load it.
