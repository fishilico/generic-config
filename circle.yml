# Configuration file for https://circleci.com/
# Inspiration from https://github.com/DevProgress/onboarding/wiki/Using-Circle-CI-with-Github-Pages-for-Continuous-Delivery

dependencies:
  pre:
    - sudo apt-get update -qq
    - sudo apt-get install -qq python-sphinx

test:
  override:
    - make all
    - make clean

deployment:
  production:
    branch: master
    commands:
      # Configure the user and email which is used with environment variables
      - git config --global user.email "$GH_EMAIL"
      - git config --global user.name "$GH_NAME"

      # Create a git repository in _build/html
      - mkdir -p _build/html
      - git -C _build/html init

      # Check-out ghpages
      - git -C _build/html remote add --fetch origin "$(git config remote.origin.url)"
      - if git -C _build/html rev-parse --verify origin/gh-pages ; then
          git -C _build/html checkout gh-pages &&
          git -C _build/html rm -rf . ;
        else
          git -C _build/html checkout --orphan gh-pages ;
        fi

      # Build Github pages with Sphinx
      - make
      # Disable Jekyll engine
      - touch _build/html/.nojekyll

      # Commit and push the new content
      # Use [ci skip] to prevent Circle-CI from testing this new commit
      - git -C _build/html add -A
      - git -C _build/html commit --allow-empty -m "Sphinx build of $CIRCLE_SHA1 [ci skip]"
      - git -C _build/html push --quiet origin gh-pages
